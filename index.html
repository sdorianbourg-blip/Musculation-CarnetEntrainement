<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carnet d'entra√Ænement ‚Äì Musculation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --primary-dark: #1d4ed8;
      --danger: #dc2626;
      --success: #16a34a;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --radius-pill: 999px;
      --radius-card: 14px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app {
  max-width: 480px;        /* largeur type smartphone, centr√© */
  margin: 12px auto 80px;  /* petit espace bas pour la barre d‚Äôonglets */
  padding: 0 12px 80px;    /* padding bas pour ne pas que le contenu passe sous la barre */
}

    header {
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 1.6rem;
      margin: 0 0 2px;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: 14px 12px 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, .06);
      margin-top: 12px;
      border: 1px solid var(--border);
    }

    h2 {
      margin: 0 0 4px;
      font-size: 1.2rem;
    }

    p {
      margin-top: 2px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    label {
      display: block;
      margin-bottom: 3px;
      font-weight: 600;
      font-size: 0.86rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      outline: none;
      background: #f9fafb;
      color: var(--text);
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }
    /* ---- Curseur √©tat de forme style iOS ---- */
.state-box {
  background: #ffffff;
  padding: 14px 16px;
  border-radius: 14px;
  box-shadow: 0 2px 7px rgba(0,0,0,0.08);
  margin-top: 8px;
  margin-bottom: 8px;
}

.state-box label {
  font-size: 0.85rem;
  font-weight: 600;
  color: #6b7280;
}

.state-value {
  text-align: center;
  margin-top: 6px;
  font-size: 1.1rem;
  font-weight: 600;
}

.state-desc {
  font-size: 0.85rem;
  margin-top: 4px;
  color: #4b5563;
}

input[type="range"].state-slider {
  -webkit-appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 5px;
  background: #d1d5db;
  outline: none;
}

input[type="range"].state-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  height: 28px;
  width: 28px;
  border-radius: 50%;
  background: #ffffff;
  border: 2px solid #3b82f6;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  cursor: pointer;
  margin-top: -11px;
}

input[type="range"].state-slider::-webkit-slider-runnable-track {
  background: #3b82f6;
}


    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, .18);
      background: #ffffff;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .col { flex: 1 1 200px; }

    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid transparent;
      padding: 8px 14px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      background: var(--primary);
      color: #ffffff;
    }

    .btn-secondary {
      background: #ffffff;
      color: var(--primary);
      border-color: var(--border);
    }

    .btn-danger {
      background: #ffffff;
      color: var(--danger);
      border-color: var(--border);
    }

    .btn-sm {
      padding: 5px 9px;
      font-size: 0.8rem;
    }

    .breadcrumb {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .link {
      color: var(--primary-dark);
      cursor: pointer;
      text-decoration: underline;
    }

    .muted {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .badge-class {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      background: var(--primary-soft);
      color: var(--primary-dark);
      font-size: 0.78rem;
      font-weight: 600;
      margin-left: 6px;
    }

    /* TABLES */

    .students-table-wrapper,
    .scroll-table {
      margin-top: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.86rem;
      background: #ffffff;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 6px 7px;
      text-align: left;
    }

    th {
      background: #f3f4f6;
      color: var(--muted);
      font-weight: 600;
      white-space: nowrap;
    }

    /* --- Colonnes √† remplir par l‚Äôobservateur --- */
.obs-header {
  background: #e0f2fe;   /* bleu tr√®s clair pour l‚Äôen-t√™te */
  font-weight: 600;
}

/* --- Colonnes √† remplir par l‚Äôobservateur --- */
.obs-header {
  background: #e0f2fe;   /* bleu tr√®s clair pour l‚Äôen-t√™te */
  font-weight: 600;
}

/* Cellules du tableau observateur */
.obs-cell {
  background: #E1ECFF;      /* bleu clair */
}

/* Champs √† remplir par l‚Äôobservateur (inputs, selects) */
.observer-field {
  background-color: #E1ECFF;
  border: 1px solid #AFC9F5;
  border-radius: 6px;
}
/* Champs importants √† remplir par l'√©l√®ve */
.important-field {
  background-color: #EAF3FF;
  border: 1px solid #B6D4FF;
  border-radius: 6px;
}

/* Bloc ressenti (tableau color√©) */
.ressenti-block {
  background-color: #FFE7E0;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #FFCEC0;
  margin-top: 8px;
}

/* Bloc bilan + validation */
.lesson-validation-block {
  background-color: #DFF6E0;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #A8E2B0;
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.lesson-validation-block label {
  font-weight: 600;
}

    .students-table td:last-child { text-align: right; }

    .student-name-btn {
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      text-align: left;
      font-size: 0.9rem;
      color: var(--primary-dark);
      cursor: pointer;
      text-decoration: underline;
    }

    .delete-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--danger);
      font-size: 0.9rem;
    }

    /* TABS */

    /* Barre d‚Äôonglets fa√ßon appli mobile en bas de l‚Äô√©cran */
.tabbar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  background: #ffffff;
  border-top: 1px solid var(--border);
  padding: 4px 8px env(safe-area-inset-bottom);
  display: flex;
  justify-content: space-between;
  gap: 4px;
  z-index: 50;
}

/* Boutons d‚Äôonglets : ic√¥ne + texte, centr√©s */
.tab-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: none;
  background: transparent;
  padding: 4px 2px;
  border-radius: 999px;
  cursor: pointer;
  color: var(--muted);
  font-size: 0.7rem;
}

/* Ic√¥ne de l‚Äôonglet */
.tab-btn-icon {
  font-size: 1.25rem;
  line-height: 1;
}

/* Label sous l‚Äôic√¥ne */
.tab-btn-label {
  margin-top: 1px;
}

/* Onglet actif */
.tab-btn.active {
  background: #e0f2fe;
  color: #1d4ed8;
  font-weight: 600;
}

.tab-btn.active .tab-btn-icon {
  color: #1d4ed8;
}

    .tab-panel { display: none; margin-top: 10px; }
    .tab-panel.active { display: block; }

    .section-title {
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    details.lesson {
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      background: #ffffff;
    }

    details.lesson summary {
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
      list-style: none;
      font-size: 0.94rem;
    }

    details.lesson[open] {
      box-shadow: 0 8px 20px rgba(15, 23, 42, .08);
    }

    details.lesson summary::-webkit-details-marker { display: none; }

    .lesson-body {
      padding: 0 10px 10px;
      border-top: 1px solid var(--border);
    }

    /* Timer de s√©ance dans chaque le√ßon */
.lesson-timer {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 10px;
  margin: 8px 0 10px;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #f9fafb;
}

.lesson-timer .timer-display {
  font-variant-numeric: tabular-nums;
  font-weight: 700;
  font-size: 2rem;        /* ‚Üê augmente encore ici si tu veux */
  padding: 8px 16px;
  border-radius: 12px;
  background: #ffffff;
  border: 2px solid #2563eb;
  color: #2563eb;
  min-width: 120px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(37,99,235,0.2);
}




    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    /* -------- Le√ßon 3 : affichage en 5 √©tapes -------- */
.steps-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  margin-top: 10px;
}

.step-card {
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #f9fafb;
  padding: 8px 10px;
}

.step-header {
  display: flex;
  align-items: baseline;
  gap: 6px;
  margin-bottom: 4px;
}

.step-number {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--primary-dark);
}

.step-title {
  font-weight: 600;
  font-size: 0.9rem;
}

.step-card p {
  margin: 0 0 4px;
  font-size: 0.8rem;
  color: var(--muted);
}
/* ----- Cha√Æne de progression back squat (√âtape 3 le√ßon 3) ----- */

.squat-progression {
  margin-top: 6px;
}

.squat-arrow-caption {
  font-size: 0.8rem;
  margin-bottom: 4px;
}

.squat-steps {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: space-between;
  margin-top: 4px;
}

.squat-step {
  flex: 1 1 80px;
  max-width: 110px;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: #f9fafb;
  padding: 6px 4px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  font-size: 0.78rem;
  transition: background 0.15s, border-color 0.15s, transform 0.08s;
}

.squat-step:hover {
  transform: translateY(-1px);
  border-color: var(--primary);
}

.squat-number {
  width: 30px;
  height: 30px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #e5e7eb;
  font-weight: 700;
}

.squat-label {
  text-align: center;
}

.squat-step.active {
  background: #eff6ff;
  border-color: var(--primary);
}

.squat-step.active .squat-number {
  background: var(--primary);
  color: #ffffff;
}
/* ---- Observation squat ‚Äì √âtape 4 ---- */
.obs-schema {
  margin-top: 8px;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #f9fafb;
}

.obs-schema img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-bottom: 8px;
}

.obs-criteria-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
}

.obs-criterion {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  border-radius: 8px;
  background: #ffffff;
  border: 1px solid var(--border);
}

.obs-criterion-label {
  font-size: 0.85rem;
  font-weight: 500;
}

.flag-options {
  display: flex;
  gap: 4px;
}

/* Boutons vert/rouge type radio */
.flag-option {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: #e5e7eb;
  cursor: pointer;
  font-size: 1.2rem;
}

.flag-option input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

/* Vert = OK */
.flag-green {
  background: #dcfce7;
  border-color: #22c55e;
}

/* Rouge = KO */
.flag-red {
  background: #fee2e2;
  border-color: #ef4444;
}

/* Quand s√©lectionn√©, on renforce le bord */
.flag-option input:checked + span {
  outline: 2px solid #111827;
  outline-offset: 1px;
}

/* ----- √âtape 4 : grille d'observation du squat ----- */

.step4-criteria-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 8px;
  margin-top: 8px;
}

.criterion-card {
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #f9fafb;
  padding: 6px 8px;
  font-size: 0.8rem;
}

.criterion-title {
  font-weight: 600;
  margin-bottom: 2px;
}

.criterion-options {
  margin-bottom: 4px;
}

.criterion-flags {
  display: flex;
  gap: 6px;
  margin-top: 2px;
}

.flag-btn {
  flex: 1;
  border-radius: 999px;
  border: 1px solid var(--border);
  padding: 4px 6px;
  font-size: 0.78rem;
  cursor: pointer;
  background: #ffffff;
}

.flag-btn.green { /* drapeau vert */
}

.flag-btn.red { /* drapeau rouge */
}

.flag-btn.active.green {
  background: #bbf7d0;
  border-color: #16a34a;
  font-weight: 600;
}

.flag-btn.active.red {
  background: #fecaca;
  border-color: #dc2626;
  font-weight: 600;
}

.step4-summary {
  font-size: 0.8rem;
}


    .pill-info {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: #f3f4f6;
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 3px;
    }

    /* Couleurs bar√®me (Degr√© 1 √† 4) */

    .deg1 { background: #fee2e2; }
    .deg2 { background: #ffedd5; }
    .deg3 { background: #dcfce7; }
    .deg4 { background: #bbf7d0; }

    /* Couleurs √©chelle de ressenti (Niveau 1 = vert ‚Üí 4 = rouge) */

    .res1 { background: #bbf7d0; } /* tr√®s facile */
    .res2 { background: #fef9c3; }
    .res3 { background: #fed7aa; }
    .res4 { background: #fecaca; } /* tr√®s difficile */

    .scale-table td,
    .scale-table th {
      font-size: 0.8rem;
      padding: 4px 5px;
    }

    .center { text-align: center; }

    /* Auto-√©valuation */

    .self-eval-box {
      margin-top: 12px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }

    .self-eval-row {
      display: grid;
      grid-template-columns: 1.5fr repeat(4, 0.6fr);
      gap: 4px;
      align-items: center;
      font-size: 0.82rem;
      margin-bottom: 4px;
    }
    .step-card {
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #f9fafb;
}

.step-header {
  display: flex;
  align-items: baseline;
  gap: 6px;
  margin-bottom: 4px;
}

.step-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  background: var(--primary-soft);
  color: var(--primary-dark);
}

.fms-level-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 6px;
  margin-top: 4px;
}

.fms-level {
  display: flex;
  gap: 4px;
  align-items: flex-start;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #ffffff;
  font-size: 0.8rem;
}

.fms-level input {
  margin-top: 3px;
}

.fms1 { background: #fee2e2; }  /* Niveau 1 = rouge clair */
.fms2 { background: #fef3c7; }  /* Niveau 2 = jaune */
.fms3 { background: #dcfce7; }  /* Niveau 3 = vert */

    .self-eval-label {
      font-weight: 500;
    }

    .self-eval-option {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
    }

    /* ---- Liste d'exercices ---- */

.exercise-filters {
  margin-top: 8px;
  margin-bottom: 8px;
}

.exercise-list {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.exercise-item {
  padding: 10px 12px;
  background: #f9fafb;
  border-radius: 10px;
  border: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 4px;
  transition: background 0.15s, border 0.15s;
}

.exercise-item:hover {
  background: #eef2ff;
  border-color: var(--primary);
}

.exercise-title-row {
  display: flex;
  justify-content: space-between;
  gap: 6px;
  align-items: center;
}

.exercise-name {
  font-weight: 600;
  font-size: 0.95rem;
}

.exercise-badges {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.exercise-badge {
  font-size: 0.74rem;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #ffffff;
}

.exercise-badge.category-haut {
  border-color: #bfdbfe;
  background: #eff6ff;
}

.exercise-badge.category-bas {
  border-color: #bbf7d0;
  background: #ecfdf3;
}

.exercise-badge.category-abdos {
  border-color: #facc15;
  background: #fef9c3;
}

.exercise-badge.category-cardio {
  border-color: #fed7aa;
  background: #fff7ed;
}

.exercise-muscles {
  font-size: 0.8rem;
  color: var(--muted);
}

/* ---- Modale fiche exercice ---- */

.exercise-modal {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.exercise-modal-content {
  background: #ffffff;
  border-radius: 14px;
  padding: 18px 16px 16px;
  width: 92%;
  max-width: 480px;
  box-shadow: 0 12px 30px rgba(15,23,42,0.25);
  max-height: 85vh;
  overflow-y: auto;
}

.close-ex-modal {
  float: right;
  cursor: pointer;
  font-size: 22px;
  font-weight: 700;
  color: #9ca3af;
}

.close-ex-modal:hover {
  color: #4b5563;
}

.exercise-modal h3 {
  margin-top: 0;
  margin-bottom: 6px;
}

.exercise-modal h4 {
  margin-bottom: 4px;
  margin-top: 10px;
  font-size: 0.9rem;
}

.exercise-modal ul {
  margin: 0 0 4px 18px;
  padding: 0;
  font-size: 0.86rem;
}

.exercise-video-link {
  display: inline-flex;
  margin-top: 4px;
  font-size: 0.84rem;
  color: var(--primary-dark);
  text-decoration: underline;
  cursor: pointer;
}

    @media (max-width: 640px) {
      .app { margin-top: 8px; }
      header h1 { font-size: 1.4rem; }
      .card { padding: 12px 10px 14px; }
      table { font-size: 0.8rem; }
      .scale-table td, .scale-table th { font-size: 0.75rem; }
      .btn { width: 100%; }
      .self-eval-row {
        grid-template-columns: 1.4fr repeat(4, 0.7fr);
      }
    }

/* --------- TH√àME CLAIR MODERNE / STYLE INSTIT --------- */

/* Fond global doux */
body {
  margin: 0;
  background: radial-gradient(circle at top left, #f9fafb 0, #e5e7eb 42%, #e5e7eb 100%);
  color: var(--text);
}

/* Conteneur type ‚Äúappli mobile‚Äù */
.app {
  max-width: 480px;
  margin: 16px auto 40px;
  padding: 0 12px;
}

/* Titre plus pr√©sent mais institutionnel */
header h1 {
  font-size: 1.8rem;
  font-weight: 800;
  letter-spacing: 0.02em;
}

header p {
  font-size: 0.9rem;
  color: #4b5563;
}

/* Cartes blanches propres */
.card {
  background: #ffffff;
  border-radius: 18px;
  border: 1px solid #e5e7eb;
  box-shadow:
    0 14px 30px rgba(15,23,42,0.08),
    0 0 0 1px rgba(148,163,184,0.12);
  padding: 16px 14px 18px;
}

/* Champs de formulaire */
input[type="text"],
input[type="date"],
input[type="number"],
select,
textarea {
  background: #f9fafb;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  color: #111827;
  font-size: 0.9rem;
}

input::placeholder,
textarea::placeholder {
  color: #9ca3af;
}

input:focus,
select:focus,
textarea:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 2px rgba(37,99,235,0.16);
  background: #ffffff;
}

/* Boutons principaux ‚Äì bleu EPS sobre */
.btn {
  border-radius: 999px;
  padding: 9px 18px;
  font-size: 0.78rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  border: none;
  color: #ffffff;
  box-shadow: 0 10px 22px rgba(37,99,235,0.35);
}

.btn:hover {
  filter: brightness(1.03);
}

/* Bouton secondaire : style contour */
.btn-secondary {
  background: #ffffff;
  border: 1px solid #cbd5f5;
  color: #1d4ed8;
  box-shadow: none;
}

/* Bouton supprimer : contour rouge l√©ger */
.btn-danger {
  background: #ffffff;
  border: 1px solid #fecaca;
  color: #b91c1c;
  box-shadow: none;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 0.74rem;
}

/* Barre d‚Äôonglets */
.tabbar {
  margin-top: 10px;
  padding: 4px;
  border-radius: 999px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  gap: 4px;
}

.tab-btn {
  flex: 1 1 auto;
  border-radius: 999px;
  border: none;
  padding: 7px 6px;
  font-size: 0.76rem;
  background: transparent;
  color: #6b7280;
}

.tab-btn.active {
  background: #2563eb;
  color: #ffffff;
  box-shadow: 0 8px 16px rgba(37,99,235,0.35);
}

/* Tableaux en mode clair propre */
table {
  background: #ffffff;
  color: #111827;
}

th {
  background: #f9fafb;
  color: #4b5563;
  border-bottom: 1px solid #e5e7eb;
}

td {
  background: #ffffff;
}

/* Partie observateur en bleu tr√®s l√©ger */
.obs-header {
  background: #e0f2fe;
  color: #1e3a8a;
}

.obs-cell {
  background: #eff6ff !important;
}

/* Bo√Æte √©tat de forme */
.state-box {
  background: #f9fafb;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 12px rgba(15,23,42,0.06);
}

.state-box label {
  color: #4b5563;
}

.state-value {
  font-size: 1.15rem;
  color: #2563eb;
}

/* Slider */
input[type="range"].state-slider {
  background: #e5e7eb;
}

input[type="range"].state-slider::-webkit-slider-runnable-track {
  background: linear-gradient(90deg, #2563eb, #1d4ed8);
}

/* Timer de s√©ance : mis en avant mais sobre */
.lesson-timer {
  background: #f9fafb;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 6px 16px rgba(15,23,42,0.07);
}

.lesson-timer .timer-display {
  font-size: 2rem;
  color: #111827;
  background: #ffffff;
  border-radius: 12px;
  border: 2px solid #2563eb;
}

/* Liste d‚Äôexercices */
.exercise-item {
  background: #f9fafb;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.exercise-item:hover {
  background: #eef2ff;
  border-color: #2563eb;
}

/* Modale exercice */
.exercise-modal-content {
  background: #ffffff;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 18px 40px rgba(15,23,42,0.25);
}

/* Badges */
.exercise-badge {
  border-color: #e5e7eb;
  background: #ffffff;
}

.exercise-badge.category-haut {
  border-color: #bfdbfe;
  background: #eff6ff;
}
.exercise-badge.category-bas {
  border-color: #bbf7d0;
  background: #ecfdf3;
}
.exercise-badge.category-abdos {
  border-color: #facc15;
  background: #fef9c3;
}
.exercise-badge.category-cardio {
  border-color: #fed7aa;
  background: #fff7ed;
}

/* Encadr√© validation de la le√ßon */
textarea[data-field="bilan"] {
  background: #f9fafb;
}

input[type="checkbox"][data-field="validated"] {
  accent-color: #2563eb;
}

@media (max-width: 640px) {
  .app {
    max-width: 100%;
    padding: 0 10px;
  }

  header h1 {
    font-size: 1.6rem;
  }

  .card {
    border-radius: 16px;
    padding: 14px 12px 16px;
  }

  .lesson-timer .timer-display {
    font-size: 1.8rem;
  }
}

  header h1 {
    font-size: 1.5rem;
  }

  .card {
    border-radius: 16px;
    padding: 14px 10px 16px;
  }

  .lesson-timer .timer-display {
    font-size: 1.8rem;
  }

  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Carnet d'entra√Ænement ‚Äì Musculation</h1>
    <p>Application locale pour suivre le travail des √©l√®ves (donn√©es stock√©es sur cet appareil).</p>
  </header>

    <!-- PAGE 1 : GESTION DES CLASSES -->
  <section id="view-classes" class="card">
  <h2>Mes classes</h2>
  <p>Si tu effaces l‚Äôhistorique ou changes d‚Äôappareil, toutes les donn√©es seront perdues.</p>

  <div class="row" style="margin-top:8px;">
    <div class="col">
      <label for="selectClass">Classe s√©lectionn√©e</label>
      <select id="selectClass"></select>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <label for="newClassName">Nouvelle classe</label>
      <input id="newClassName" type="text" placeholder="Ex : 206, 3eB, Term 2‚Ä¶">
    </div>
    <div class="col" style="display:flex;flex-direction:column;gap:6px;justify-content:flex-end;">
      <button id="btnAddClass" class="btn">+ Ajouter une classe</button>
      <!-- üîµ m√™me ID qu‚Äôavant, seul le texte change -->
      <button id="btnConfigTeams" class="btn btn-secondary">Aller dans ma classe</button>
      <button id="btnDeleteClass" class="btn btn-danger">Supprimer la classe</button>
    </div>
  </div>
</section>

  <!-- PAGE 2 : √âL√àVES -->
  <section id="view-students" class="card" style="display:none;">
    <div class="breadcrumb">
      <span class="link" id="backToClasses">&larr; Retour aux classes</span>
    </div>
    <h2>√âl√®ves de la classe <span id="studentsClassName"></span></h2>
    <p>Ajoute les pr√©noms les uns √† la suite des autres, puis clique sur ¬´ Ouvrir mon carnet ¬ª.</p>

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <label for="newStudentName">Ajouter un √©l√®ve</label>
        <input id="newStudentName" type="text" placeholder="Pr√©nom (ex : Zo√©)">
      </div>
      <div class="col" style="display:flex;align-items:flex-end;">
        <button id="btnAddStudent" class="btn">+ Ajouter l'√©l√®ve</button>
      </div>
    </div>

    <div class="section-title">Liste des √©l√®ves</div>
    <div class="students-table-wrapper">
      <table class="students-table">
        <thead>
        <tr>
          <th>#</th>
          <th>Pr√©nom</th>
          <th>Action</th>
          <th>Supprimer</th>
        </tr>
        </thead>
        <tbody id="studentsList"></tbody>
      </table>
    </div>
  </section>

  <!-- PAGE 3 : CARNET D'UN √âL√àVE -->
  <section id="view-carnet" class="card" style="display:none;">
    <div class="breadcrumb">
      <span class="link" id="backToStudents">&larr; Retour aux pr√©noms</span>
    </div>
    <h2>
      Carnet d'entra√Ænement de
      <span id="carnetStudentName"></span>
      <span class="badge-class" id="carnetClassName"></span>
    </h2>

    <!-- Onglets -->
   <div class="tabbar">
    <button class="tab-btn" data-tab="lessons">
    <span class="tab-btn-icon">üìò</span>
    <span class="tab-btn-label">Carnet</span>
  </button>
  <button class="tab-btn active" data-tab="muscles">
    <span class="tab-btn-icon">üí™</span>
    <span class="tab-btn-label">Muscles</span>
  </button>

  <button class="tab-btn" data-tab="evaluation">
    <span class="tab-btn-icon">üéØ</span>
    <span class="tab-btn-label">√âval.</span>
  </button>

  <button class="tab-btn" data-tab="infos">
    <span class="tab-btn-icon">üí°</span>
    <span class="tab-btn-label">Infos</span>
  </button>

  <button class="tab-btn" data-tab="exercises">
    <span class="tab-btn-icon">üèãÔ∏è</span>
    <span class="tab-btn-label">Exos</span>
  </button>
</div>



    <!-- Onglet 1 : MUSCLES -->
    <div id="tab-muscles" class="tab-panel active">
      <div class="section-title">Exemples d‚Äôactions que permettent les muscles</div>
      <p class="muted">
        Compl√®te les colonnes ¬´ Exemple d'exercice ¬ª et ¬´ N¬∞ sur le sch√©ma ¬ª.
      </p>

      <div style="margin:6px 0 10px;">
        <img src="Muscles.png"
     alt="Sch√©ma des principaux muscles."
     style="max-width:100%;height:auto;border-radius:10px;border:1px solid var(--border);">
      </div>

      <div id="musclesSheetContainer" class="scroll-table"></div>
    </div>

    <!-- Onglet 2 : MON CARNET -->
    <div id="tab-lessons" class="tab-panel">
      <p class="muted">
        Pour chaque le√ßon : choisis ton mobile, construis ta s√©ance (√©chauffement + s√©ries d‚Äôexercices),
        remplis l‚Äô√©chelle de ressenti puis r√©dige un court bilan.
      </p>
      <div id="lessonsContainer"></div>
    </div>

    <!-- Onglet 3 : √âVALUATION ‚Äì BAR√àME + AUTO-√âVAL -->
    <div id="tab-evaluation" class="tab-panel">
      <div class="section-title">Bar√®me d‚Äô√©valuation ‚Äì Musculation poids de corps</div>
      <p class="muted">
        Rep√®res du r√©f√©rentiel officiel bac g√©n√©ral / technologique ‚Äì Musculation poids de corps.
      </p>

<!-- AFL1 √âl√©ment 1 -->
      <div class="section-title">AFL1 ‚Äì √âl√©ment 1 : motricit√© sp√©cifique (trajet, posture, respiration, rythme, intensit√©, r√©cup√©ration) ‚Äì /8 pts</div>
      <div class="scroll-table">
        <table class="scale-table">
          <thead>
          <tr>
            <th>Degr√©</th>
            <th class="deg1">Degr√© 1</th>
            <th class="deg2">Degr√© 2</th>
            <th class="deg3">Degr√© 3</th>
            <th class="deg4">Degr√© 4</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Description</td>
            <td class="deg1">
              Prestation encore √©loign√©e du projet. Trajets et postures donnent peu de s√©curit√©, la gestion de l‚Äôeffort ne permet pas vraiment d‚Äôobtenir les effets vis√©s.
            </td>
            <td class="deg2">
              L‚Äô√©l√®ve sait se placer. Respiration et rythme sont mis en place mais ne sont pas vraiment accord√©s avec le th√®me d‚Äôentra√Ænement choisi.
            </td>
            <td class="deg3">
              S√©ance globalement en lien avec le th√®me. Respiration et rythme sont adapt√©s. Les charges restent coh√©rentes mais pourraient √™tre mieux ajust√©es. La majorit√© des exercices est r√©alis√©e de fa√ßon pertinente.
            </td>
            <td class="deg4">
              Exercices dont le rythme et la recherche de d√©formation montrent une vraie ma√Ætrise de l‚Äôentra√Ænement : trajets et amplitudes efficaces et s√©curis√©s. Organisation de la s√©ance (r√©cup√©ration, intensit√©) qui renforce les effets recherch√©s, homog√©n√©it√© sur l‚Äôensemble des exercices.
            </td>
          </tr>
          <tr>
            <td>Points</td>
            <td class="deg1 center">0 √† 2 pts</td>
            <td class="deg2 center">2,5 √† 4 pts</td>
            <td class="deg3 center">4,5 √† 6 pts</td>
            <td class="deg4 center">6,5 √† 8 pts</td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- AFL1 √âl√©ment 2 -->
      <div class="section-title" style="margin-top:12px;">
        AFL1 ‚Äì √âl√©ment 2 : √©chauffement, √©tirements, alternance effort / r√©cup√©ration ‚Äì /4 pts
      </div>
      <div class="scroll-table">
        <table class="scale-table">
          <thead>
          <tr>
            <th>Degr√©</th>
            <th class="deg1">Degr√© 1</th>
            <th class="deg2">Degr√© 2</th>
            <th class="deg3">Degr√© 3</th>
            <th class="deg4">Degr√© 4</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Description</td>
            <td class="deg1">
              √âchauffement incomplet. √âtirements et r√©cup√©ration sont en grande partie oubli√©s ou mal utilis√©s.
            </td>
            <td class="deg2">
              √âchauffement complet mais peu en lien avec la s√©ance pr√©vue. √âtirements et r√©cup√©rations sont irr√©guliers ou peu r√©fl√©chis.
            </td>
            <td class="deg3">
              √âchauffement coh√©rent avec la s√©ance propos√©e. √âtirements et r√©cup√©ration sont choisis de mani√®re pertinente au regard du travail r√©alis√©.
            </td>
            <td class="deg4">
              Pr√©paration compl√®te, adapt√©e au mobile choisi. L‚Äô√©l√®ve se pr√©pare √† un effort optimal en s√©curit√© et sait organiser alternances effort / r√©cup√©ration pour renforcer les effets vis√©s.
            </td>
          </tr>
          <tr>
            <td>Points</td>
            <td class="deg1 center">0 √† 1 pt</td>
            <td class="deg2 center">1,25 √† 2 pts</td>
            <td class="deg3 center">2,25 √† 3 pts</td>
            <td class="deg4 center">3,25 √† 4 pts</td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- AFL2 -->
      <div class="section-title" style="margin-top:12px;">
        AFL2 ‚Äì Carnet, projet, param√®tres d‚Äôentra√Ænement, bilans
      </div>
      <div class="scroll-table">
        <table class="scale-table">
          <thead>
          <tr>
            <th>√âl√©ments √©valu√©s</th>
            <th class="deg1">Degr√© 1</th>
            <th class="deg2">Degr√© 2</th>
            <th class="deg3">Degr√© 3</th>
            <th class="deg4">Degr√© 4</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Utilisation du carnet, projet personnel, param√®tres, bilans</td>
            <td class="deg1">
              Carnet rempli de fa√ßon tr√®s succincte. Projet personnel peu rep√©rable. Param√®tres d‚Äôentra√Ænement souvent absents ou peu justifi√©s. Bilans st√©r√©otyp√©s, sans vraie projection vers la s√©ance suivante.
            </td>
            <td class="deg2">
              Carnet incomplet et peu utile pour r√©guler le travail. S√©ance pens√©e mais avec des incoh√©rences (charges, √©tirements, r√©partition des groupes musculaires‚Ä¶). Bilans r√©dig√©s avec un vocabulaire approximatif et des erreurs dans la conception.
            </td>
            <td class="deg3">
              Carnet rempli √† chaque s√©ance. Bilans complets. La majorit√© des param√®tres (charges, pourcentages, s√©ries, r√©p√©titions, r√©cup√©ration, rythme) est d√©crite et en lien avec le th√®me. Bilans tenant compte du ressenti et proposant des pistes de r√©gulation, m√™me s‚Äôil reste quelques approximations.
            </td>
            <td class="deg4">
              Carnet tr√®s pr√©cis : tous les param√®tres sont renseign√©s et coh√©rents avec le th√®me d‚Äôentra√Ænement. Projet personnel affirm√©, utilisation possible de techniques d‚Äôintensification. Bilans complets et r√©fl√©chis, r√©gulations √† bon escient et conception argument√©e de la s√©ance future.
            </td>
          </tr>
          <tr>
            <td>Exemples de points</td>
            <td class="deg1">
              Cas n¬∞1 : 1,5 pt ‚Äì Cas n¬∞2 : 1 pt ‚Äì Cas n¬∞3 : 0,5 pt
            </td>
            <td class="deg2">
              Cas n¬∞1 : 3 pts ‚Äì Cas n¬∞2 : 2 pts ‚Äì Cas n¬∞3 : 1 pt
            </td>
            <td class="deg3">
              Cas n¬∞1 : 4,5 pts ‚Äì Cas n¬∞2 : 3 pts ‚Äì Cas n¬∞3 : 1,5 pt
            </td>
            <td class="deg4">
              Cas n¬∞1 : 6 pts ‚Äì Cas n¬∞2 : 4 pts ‚Äì Cas n¬∞3 : 2 pts
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- AFL3 -->
      <div class="section-title" style="margin-top:12px;">
        AFL3 ‚Äì Coop√©rer pour faire progresser : coacher son partenaire
      </div>
      <div class="scroll-table">
        <table class="scale-table">
          <thead>
          <tr>
            <th>Coaching</th>
            <th class="deg1">Degr√© 1</th>
            <th class="deg2">Degr√© 2</th>
            <th class="deg3">Degr√© 3</th>
            <th class="deg4">Degr√© 4</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Description</td>
            <td class="deg1">
              Coaching tr√®s peu impliqu√© : pas de chronom√©trage fiable, peu ou pas de corrections. Postures parfois dangereuses non signal√©es.
            </td>
            <td class="deg2">
              Coaching distant : l‚Äôaccent est surtout mis sur le chrono, les corrections sont tardives ou partielles, certaines erreurs persistent.
            </td>
            <td class="deg3">
              Coaching attentif : le partenaire surveille chrono, posture, respiration et rythme d‚Äôex√©cution, m√™me s‚Äôil a parfois du mal √† tout g√©rer simultan√©ment.
            </td>
            <td class="deg4">
              Coaching pr√©cis et bienveillant : conseils pertinents, encouragements, corrections rapides. Contribue r√©ellement √† la progression de son partenaire.
            </td>
          </tr>
          <tr>
            <td>Exemples de points</td>
            <td class="deg1">
              Cas n¬∞1 : 1,5 pt ‚Äì Cas n¬∞2 : 1 pt ‚Äì Cas n¬∞3 : 0,5 pt
            </td>
            <td class="deg2">
              Cas n¬∞1 : 3 pts ‚Äì Cas n¬∞2 : 2 pts ‚Äì Cas n¬∞3 : 1 pt
            </td>
            <td class="deg3">
              Cas n¬∞1 : 4,5 pts ‚Äì Cas n¬∞2 : 3 pts ‚Äì Cas n¬∞3 : 1,5 pt
            </td>
            <td class="deg4">
              Cas n¬∞1 : 6 pts ‚Äì Cas n¬∞2 : 4 pts ‚Äì Cas n¬∞3 : 2 pts
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- AUTO-√âVALUATION -->
      <div class="self-eval-box">
        <div class="section-title">Mon auto-√©valuation (fin de s√©quence)</div>
        <p class="muted" style="margin-bottom:6px;">
          Choisis le degr√© qui correspond le mieux √† ton niveau pour chaque crit√®re, en t‚Äôappuyant sur le bar√®me ci-dessus.
        </p>

        <div class="self-eval-row">
          <div class="self-eval-label">AFL1 ‚Äì √âl√©ment 1</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e1" value="1" data-self-afl="afl1e1"> 1</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e1" value="2" data-self-afl="afl1e1"> 2</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e1" value="3" data-self-afl="afl1e1"> 3</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e1" value="4" data-self-afl="afl1e1"> 4</div>
        </div>

        <div class="self-eval-row">
          <div class="self-eval-label">AFL1 ‚Äì √âl√©ment 2</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e2" value="1" data-self-afl="afl1e2"> 1</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e2" value="2" data-self-afl="afl1e2"> 2</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e2" value="3" data-self-afl="afl1e2"> 3</div>
          <div class="self-eval-option"><input type="radio" name="self_afl1e2" value="4" data-self-afl="afl1e2"> 4</div>
        </div>

        <div class="self-eval-row">
          <div class="self-eval-label">AFL2</div>
          <div class="self-eval-option"><input type="radio" name="self_afl2" value="1" data-self-afl="afl2"> 1</div>
          <div class="self-eval-option"><input type="radio" name="self_afl2" value="2" data-self-afl="afl2"> 2</div>
          <div class="self-eval-option"><input type="radio" name="self_afl2" value="3" data-self-afl="afl2"> 3</div>
          <div class="self-eval-option"><input type="radio" name="self_afl2" value="4" data-self-afl="afl2"> 4</div>
        </div>

        <div class="self-eval-row">
          <div class="self-eval-label">AFL3</div>
          <div class="self-eval-option"><input type="radio" name="self_afl3" value="1" data-self-afl="afl3"> 1</div>
          <div class="self-eval-option"><input type="radio" name="self_afl3" value="2" data-self-afl="afl3"> 2</div>
          <div class="self-eval-option"><input type="radio" name="self_afl3" value="3" data-self-afl="afl3"> 3</div>
          <div class="self-eval-option"><input type="radio" name="self_afl3" value="4" data-self-afl="afl3"> 4</div>
        </div>

        <div style="margin-top:6px;">
          <label for="selfEvalNote">Ma note (ex : 14/20 ou 16/24)</label>
          <input type="text" id="selfEvalNote" placeholder="Ma note finale‚Ä¶">
          <p id="selfEvalSummary" class="muted" style="margin-top:4px;">Ma note : ‚Ä¶</p>
        </div>
      </div>
    </div>

    <!-- Onglet 4 : BON √Ä SAVOIR (m√™me structure que ta fiche) -->
    <div id="tab-infos" class="tab-panel">
      <div class="section-title">Bon √† savoir</div>

      <!-- 1. 2 mobliles possibles -->
      <div class="scroll-table">
        <table>
          <thead>
          <tr>
            <th>2 Mobiles possibles</th>
            <th>1 ‚Äì Puissance</th>
            <th>2 ‚Äì Tonification</th>
            <th>Liens utiles</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>Intensit√©</td>
            <td>
              4 s√©ries de 8 exercices encha√Æn√©s de 30‚Äô‚Äô  
              (au moins 2 exercices de cardio).
            </td>
            <td>
              3 s√©ries de 10 exercices encha√Æn√©s de 30‚Äô‚Äô √† 45‚Äô‚Äô  
              (au moins 3 exercices de cardio).
            </td>
            <td rowspan="3">
              <ul class="muted" style="padding-left:16px;margin:0;">
                <li>Programmes de musculation sans mat√©riel.</li>
                <li>Exemples d‚Äôexercices de musculation.</li>
                <li>Programmes complets de musculation sans mat√©riel.</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>Vitesse d‚Äôex√©cution</td>
            <td>Rapide avec acc√©l√©ration (explosivit√©).</td>
            <td>Soutenue.</td>
          </tr>
          <tr>
            <td>R√©cup√©ration</td>
            <td>Active ‚Äì 3‚Äô entre les s√©ries.</td>
            <td>Active ‚Äì 1‚Äô entre les s√©ries.</td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- 2. Tu seras jug√©(e) sur -->
      <div class="section-title" style="margin-top:10px;">Tu seras jug√©(e) sur :</div>
      <div class="scroll-table">
        <table>
          <thead>
          <tr>
            <th>La r√©alisation du programme ‚Äì AFL1</th>
            <th>R√©guler son travail & conception du programme ‚Äì AFL2</th>
            <th>Ton r√¥le de coach ‚Äì AFL3</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>
              <ul class="muted" style="padding-left:16px;margin:0;">
                <li>Posture bien r√©alis√©e.</li>
                <li>Respiration bien cal√©e.</li>
                <li>Rythme adapt√©.</li>
                <li>Temps de r√©cup√©ration respect√©s.</li>
                <li>√âchauffement et √©tirements en fin de programme.</li>
                <li>La r√©cup√©ration.</li>
              </ul>
            </td>
            <td>
              <ul class="muted" style="padding-left:16px;margin:0;">
                <li>La tenue du carnet d‚Äôentra√Ænement.</li>
                <li>Les bilans de s√©ance.</li>
                <li>La coh√©rence des exercices / mobile / muscles sollicit√©s.</li>
              </ul>
            </td>
            <td>
              <ul class="muted" style="padding-left:16px;margin:0;">
                <li>Le coaching sur les postures de ton bin√¥me.</li>
                <li>Le chronom√©trage.</li>
              </ul>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- 3. Agir en s√©curit√© -->
      <div class="section-title" style="margin-top:10px;">Agir en s√©curit√©</div>
      <ul class="muted" style="padding-left:18px;">
        <li>Respecter la posture : corps gain√©, tonicit√© g√©n√©rale, alignement des segments, regard plac√©.</li>
        <li>Expirer en fin d‚Äôeffort.</li>
        <li>Pas de blocage articulaire.</li>
        <li>Pas de cambrure.</li>
        <li>Charge adapt√©e.</li>
        <li>S‚Äôhydrater pendant les phases de r√©cup√©ration.</li>
      </ul>

      <!-- 4. Dossier d'√©valuation -->
      <div class="section-title" style="margin-top:8px;">Ton dossier √† pr√©senter pour l‚Äô√©valuation devra comprendre :</div>
      <ul class="muted" style="padding-left:18px;">
        <li>Ton projet : le choix du mobile justifi√©.</li>
        <li>Ton √©chauffement.</li>
        <li>
          Ton programme : √©quilibr√© et/ou adapt√© (2 ou 3 cardio, bas du corps, haut du corps, abdos),  
          les muscles sollicit√©s, 8 ou 10 exercices, nombre de s√©ries, temps de r√©cup√©ration.
        </li>
        <li>Les √©tirements pr√©vus.</li>
        <li>Dur√©e maxi 40 minutes.</li>
        <li>Ton bilan de cycle et la projection sur un cycle ult√©rieur.</li>
        <li>Ton carnet d‚Äôentra√Ænement compl√©t√© ; les documents partag√©s remplis.</li>
      </ul>

      <!-- 5. √âchelle de ressenti -->
      <div class="section-title" style="margin-top:8px;">√âchelle de ressenti</div>
      <div class="scroll-table">
        <table class="scale-table">
          <thead>
          <tr>
            <th>√âchelle de ressenti</th>
            <th>Perception de l‚Äôeffort</th>
            <th>Sensations musculaires</th>
            <th>Sensations respiratoires</th>
            <th>Sensation de chaleur</th>
          </tr>
          </thead>
          <tbody>
          <tr class="res1">
            <td><strong>Niveau 1</strong></td>
            <td>Un peu difficile</td>
            <td>Faibles contractions</td>
            <td>Respiration rapide</td>
            <td>Commence √† transpirer</td>
          </tr>
          <tr class="res2">
            <td><strong>Niveau 2</strong></td>
            <td>Difficile</td>
            <td>Fatigue musculaire</td>
            <td>Difficult√© √† reprendre son souffle</td>
            <td>Tr√®s chaud, transpiration plus importante</td>
          </tr>
          <tr class="res3">
            <td><strong>Niveau 3</strong></td>
            <td>Tr√®s difficile</td>
            <td>Muscles restent durs</td>
            <td>Tr√®s essouffl√©</td>
            <td>Rougeurs, transpiration importante</td>
          </tr>
          <tr class="res4">
            <td><strong>Niveau 4</strong></td>
            <td>Trop difficile</td>
            <td>T√©tanie</td>
            <td>√Ä bout de souffle</td>
            <td>Transpiration abondante</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
        <!-- Onglet 5 : BIBLIOTH√àQUE D'EXERCICES -->
    <div id="tab-exercises" class="tab-panel">
      <div class="section-title">Biblioth√®que d'exercices</div>
      <p class="muted">
        Filtre les exercices par cat√©gorie et par muscles. Clique sur un exercice pour afficher la fiche :
        crit√®res de r√©alisation, consignes de s√©curit√©, variantes‚Ä¶
      </p>

      <div class="card exercise-filters" style="padding:8px 10px;">
        <div class="row">
          <div class="col">
            <label for="exerciseCategoryFilter">Cat√©gorie</label>
            <select id="exerciseCategoryFilter">
              <option value="ALL">Toutes</option>
              <option value="Haut du corps">Haut du corps</option>
              <option value="Bas du corps">Bas du corps</option>
              <option value="Abdominaux">Abdominaux</option>
              <option value="Cardio">Cardio</option>
            </select>
          </div>
          <div class="col">
            <label for="exerciseSearch">Recherche (nom / muscles)</label>
            <input id="exerciseSearch" type="text"
                   placeholder="Ex : pectoraux, squat, triceps‚Ä¶">
          </div>
        </div>
      </div>

      <div id="exerciseList" class="exercise-list"></div>

      <!-- Modale fiche exercice -->
      <div id="exerciseModal" class="exercise-modal" style="display:none;">
        <div class="exercise-modal-content">
          <span id="closeExerciseModal" class="close-ex-modal">&times;</span>
          <h3 id="exerciseTitle"></h3>
          <p class="muted" style="margin-top:0;">
            <strong>Cat√©gorie :</strong> <span id="exerciseCategory"></span> ‚Äì
            <strong>Muscles sollicit√©s :</strong> <span id="exerciseMuscles"></span>
          </p>

          <div id="exerciseEquipmentLine" class="muted" style="margin-bottom:6px;"></div>

          <h4>Consignes de s√©curit√©</h4>
          <ul id="exerciseSafety"></ul>

          <h4>Crit√®res de r√©alisation</h4>
          <ul id="exerciseCriteria"></ul>

          <h4>Variantes / progressions</h4>
          <ul id="exerciseVariations"></ul>

          <a id="exerciseVideoLink" class="exercise-video-link" href="#" target="_blank" style="display:none;">
            Voir la vid√©o de d√©monstration
          </a>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
const STORAGE_KEY = "muscu_carnet_app_v6"; // ou ton nom actuel
const DELETE_CODE = "EPS2025"; // <<< code enseignant √† choisir
// URL de la base temps r√©el Firebase (REST API)
const FIREBASE_URL = "https://carnet-d-entrainement-muscu-default-rtdb.europe-west1.firebasedatabase.app/carnetData.json";

  const LESSON_COUNT = 8;
  const EXO_LINES = 10;
  const STATE_DESCRIPTIONS = {
  1: "Aucune √©nergie, envie de se reposer imm√©diatement.",
  2: "Tr√®s fatigu√©, difficult√© √† se concentrer ou √† bouger, tout semble un effort.",
  3: "Fatigu√©, sensation de lourdeur, manque d'√©nergie notable.",
  4: "Plut√¥t fatigu√©, l√©ger manque de dynamisme, mais encore capable de participer.",
  5: "Normal, ni particuli√®rement fatigu√©, ni en pleine forme, √©tat neutre.",
  6: "Assez en forme, ressent de l'√©nergie, mais pas au maximum.",
  7: "En forme, dynamique et motiv√©, pr√™t pour une activit√© normale.",
  8: "Tr√®s en forme, beaucoup d‚Äô√©nergie et d‚Äôenthousiasme, pr√™t √† se d√©passer.",
  9: "En excellente forme, grande vitalit√©, aucune fatigue ressentie.",
  10: "Au top ! √âtat optimal, √©nergie d√©bordante, pr√™t pour un effort intense."
};
// --- Exercices propos√©s selon les axes √† travailler (√âtape 4) ---
const AXIS_EXERCISES = {
  A: {
    label: "(A) Force",
    description: "Renforcer la force sur les jambes et le contr√¥le en charge.",
    exercises: [
      "Pouss√©e lat√©rale contre un mur avec ballon (travail unilat√©ral et contr√¥le du genou).",
      "Split squat / fente avant avec charge tenue sur l'√©paule ou devant la poitrine.",
      "Abduction de hanche en d√©cubitus lat√©ral avec √©lastique autour des genoux."
    ]
  },
  B: {
    label: "(B) Stabilit√©",
    description: "Am√©liorer le gainage et la stabilit√© du tronc pendant le squat.",
    exercises: [
      "Dead bug (bras/jambes oppos√©s) en gardant le bas du dos coll√© au sol.",
      "Hip thrust / pont avec les pieds au mur pour stabiliser bassin et tronc.",
      "Gainage lat√©ral (sur coude) en gardant le bassin align√©."
    ]
  },
  C: {
    label: "(C) Mobilit√©",
    description: "Travailler la mobilit√© de hanche, cheville et colonne.",
    exercises: [
      "Fente genou au sol avec charge l√©g√®re (kettlebell ou halt√®re) devant le corps.",
      "Auto-massage au foam-roller sur la cha√Æne ant√©rieure / lat√©rale de la cuisse.",
      "√âtirement/mobilit√© des √©paules sur banc (position de pri√®re, bras sur√©lev√©s)."
    ]
  }
};

// √âtape 4 ‚Äì lien entre crit√®res et axes de travail
const STEP4_CONFIG = {
  dos:        { axis: "C", axisLabel: "Mobilit√©" },
  equilibre:  { axis: "B", axisLabel: "Stabilit√©" },
  talons:     { axis: "C", axisLabel: "Mobilit√©" },
  amplitude:  { axis: "C", axisLabel: "Mobilit√©" },
  genoux:     { axis: "A", axisLabel: "Force" }
};

function updateStep4Summary(lessonIndex) {
  const student = getSelectedStudent();
  if (!student || !student.carnet || !student.carnet.lessons[lessonIndex]) return;

  const lesson = student.carnet.lessons[lessonIndex];

  const summaryEl = document.getElementById(`obsSummary_${lessonIndex}`);
  const axisEl = document.getElementById(`obsAxisExos_${lessonIndex}`);
  if (!summaryEl || !axisEl) return;

  // On regarde quels crit√®res sont en "KO"
  const problems = [];

  if (lesson.obsDos === "KO")       problems.push("dos");
  if (lesson.obsEquilibre === "KO") problems.push("√©quilibre");
  if (lesson.obsGenoux === "KO")    problems.push("genoux");
  if (lesson.obsAmplitude === "KO") problems.push("amplitude");
  if (lesson.obsTalons === "KO")    problems.push("talons");

  // Rien de KO ‚Üí tout est OK
  if (problems.length === 0) {
    summaryEl.textContent =
      "Tout est ‚úÖ : ton squat est correctement r√©alis√© sur ces crit√®res.";
    axisEl.innerHTML =
      "<em>Pas de priorit√© particuli√®re, tu peux continuer √† progresser en charge progressivement.</em>";
    return;
  }

  const axes = [];
  const exos = [];

  // R√®gles que tu m'as donn√©es :
  // - prb dos ‚Üí travail mobilit√©
  // - prb √©quilibre ‚Üí travail stabilit√©
  // - prb genoux ‚Üí travail force
  // - prb amplitude ‚Üí travail mobilit√©
  // - prb talons ‚Üí travail mobilit√©

  if (problems.includes("dos")) {
    axes.push("Mobilit√© du dos et contr√¥le du tronc");
    exos.push(
      "‚Ä¢ Mobilit√© de la colonne (chat/vache, rotations thoraciques)<br>" +
      "‚Ä¢ Gainage (planche, dead bug) pour fixer le tronc"
    );
  }

  if (problems.includes("√©quilibre")) {
    axes.push("Stabilit√© et √©quilibre global");
    exos.push(
      "‚Ä¢ Squat au mur ou box squat pour se stabiliser<br>" +
      "‚Ä¢ Travail sur une jambe (√©quilibre sur un pied, fente statique)"
    );
  }

  if (problems.includes("genoux")) {
    axes.push("Force et contr√¥le au niveau des genoux");
    exos.push(
      "‚Ä¢ Squats lents en surveillant l‚Äôalignement genou/pied<br>" +
      "‚Ä¢ Fentes avant avec focus sur l‚Äôaxe genou/pied"
    );
  }

  if (problems.includes("amplitude")) {
    axes.push("Mobilit√© de hanches et de chevilles");
    exos.push(
      "‚Ä¢ √âtirements de hanches (fente basse, pigeon)<br>" +
      "‚Ä¢ Travail de flexion de cheville (genou vers l‚Äôavant contre un mur)"
    );
  }

  if (problems.includes("talons")) {
    axes.push("Mobilit√© de la cheville (talons qui restent au sol)");
    exos.push(
      "‚Ä¢ √âtirements de mollets<br>" +
      "‚Ä¢ Squat avec talons sur√©lev√©s puis baisser progressivement la cale"
    );
  }

  // Texte r√©cap
  summaryEl.textContent =
    "Axes prioritaires pour am√©liorer ton squat : " + axes.join(" ‚Äì ") + ".";

  // Liste des exos
  axisEl.innerHTML =
    "<strong>Exemples d‚Äôexercices √† travailler :</strong><br>" +
    exos.join("<br><br>");
}


// ------------------- BIBLIOTH√àQUE D'EXERCICES -------------------

const EXERCISES = [
  // ========== HAUT DU CORPS / TRONC / √âPAULES ==========

  {
    name: "Pompes classiques",
    category: "Haut du corps",
    muscles: "Pectoraux, triceps, delto√Ødes, gainage",
    musclesTags: ["pectoraux", "triceps", "√©paules", "delto√Ødes", "bras", "gainage"],
    equipment: "Poids de corps",
    safety: [
      "Garder le corps align√© de la t√™te aux pieds.",
      "Ne pas cambrer le bas du dos.",
      "Mains sous les √©paules ou l√©g√®rement plus larges."
    ],
    criteria: [
      "Descente contr√¥l√©e, poitrine proche du sol.",
      "Coudes proches du corps ou l√©g√®rement ouverts, pas √† 90¬∞.",
      "Bras tendus en haut sans verrouiller violemment les coudes."
    ],
    variations: [
      "Plus facile : pompes sur les genoux ou mains sur un banc.",
      "Plus difficile : pompes avec pieds sur√©lev√©s ou tempo lent."
    ],
    videoUrl: ""
  },

  {
    name: "Pompes triceps (mains serr√©es) / pompes serr√©es",
    category: "Haut du corps",
    muscles: "Triceps, pectoraux internes, gainage",
    musclesTags: ["triceps", "bras", "pectoraux"],
    equipment: "Poids de corps",
    safety: [
      "Mains serr√©es sous la poitrine (forme de losange ou mains parall√®les).",
      "Coudes proches du buste.",
      "Corps gain√© pendant tout le mouvement."
    ],
    criteria: [
      "Descendre jusqu‚Äô√† environ 90¬∞ de flexion de coude.",
      "Pousser en gardant le bassin align√© (ne pas s‚Äôaffaisser).",
      "Souffler en poussant, inspirer en redescendant."
    ],
    variations: [
      "Plus facile : sur les genoux.",
      "Plus difficile : tempo lent ou ajout d‚Äôun lest (sac)."
    ],
    videoUrl: ""
  },

  {
    name: "Pompes larges",
    category: "Haut du corps",
    muscles: "Pectoraux, delto√Ødes, triceps, gainage",
    musclesTags: ["pectoraux", "triceps", "√©paules", "gainage"],
    equipment: "Poids de corps",
    safety: [
      "Mains plus larges que les √©paules.",
      "Ne pas laisser les coudes partir √† 90¬∞ sur les c√¥t√©s.",
      "Corps align√©, abdos engag√©s."
    ],
    criteria: [
      "Descendre poitrine entre les mains.",
      "Remonter en poussant fort dans les paumes.",
      "Rythme r√©gulier et contr√¥l√©."
    ],
    variations: [
      "Plus facile : sur les genoux.",
      "Plus difficile : tempo lent, maintien en bas quelques secondes."
    ],
    videoUrl: ""
  },

  {
    name: "Pompes en T",
    category: "Haut du corps",
    muscles: "Pectoraux, √©paules, triceps, obliques, gainage",
    musclesTags: ["pectoraux", "√©paules", "triceps", "obliques", "gainage"],
    equipment: "Poids de corps",
    safety: [
      "Commencer en position de pompe classique.",
      "Limiter l‚Äôamplitude de rotation si douleur d‚Äô√©paule.",
      "Regard suivant la main qui s‚Äôouvre."
    ],
    criteria: [
      "Faire une pompe puis ouvrir en planche lat√©rale (bras vers le plafond).",
      "Hanches align√©es, pas de bassin qui tombe.",
      "Alterner c√¥t√© droit / gauche."
    ],
    variations: [
      "Plus facile : sur les genoux.",
      "Plus difficile : tempo lent ou charge l√©g√®re dans la main qui s‚Äôouvre."
    ],
    videoUrl: ""
  },

  {
    name: "Pompes piqu√©es",
    category: "Haut du corps",
    muscles: "√âpaules (delto√Ødes), triceps, haut du dos, gainage",
    musclesTags: ["√©paules", "delto√Ødes", "triceps", "haut du dos"],
    equipment: "Poids de corps",
    safety: [
      "Former un V invers√© : bassin vers le plafond.",
      "Regard vers les pieds ou entre les mains.",
      "Descendre en contr√¥le, ne pas cogner la t√™te au sol."
    ],
    criteria: [
      "Fl√©chir les coudes en amenant la t√™te vers le sol entre les mains.",
      "Pousser fort pour revenir en V invers√©.",
      "Respiration r√©guli√®re, abdos engag√©s."
    ],
    variations: [
      "Plus facile : pieds plus proches des mains (moins de charge).",
      "Plus difficile : pieds sur√©lev√©s."
    ],
    videoUrl: ""
  },

  {
    name: "Rowing √©lastique debout",
    category: "Haut du corps",
    muscles: "Grand dorsal, biceps, muscles entre les omoplates",
    musclesTags: ["dos", "grand dorsal", "biceps", "omoplates"],
    equipment: "√âlastique",
    safety: [
      "Tronc l√©g√®rement pench√© en avant, dos droit.",
      "Ne pas tirer avec le bas du dos.",
      "√âpaules basses (ne pas les hausser)."
    ],
    criteria: [
      "Amener les coudes vers l‚Äôarri√®re en serrant les omoplates.",
      "Revenir en contr√¥lant la tension de l‚Äô√©lastique.",
      "Inspirer en revenant, souffler en tirant."
    ],
    variations: [
      "Plus facile : √©lastique moins tendu, prise plus proche du centre.",
      "Plus difficile : reculer pour tendre davantage l‚Äô√©lastique."
    ],
    videoUrl: ""
  },

  {
    name: "Curl biceps avec halt√®res ou √©lastique",
    category: "Haut du corps",
    muscles: "Biceps, avant-bras",
    musclesTags: ["biceps", "avant-bras", "bras"],
    equipment: "Halt√®res ou √©lastique",
    safety: [
      "Coudes proches du corps, fix√©s.",
      "Dos droit, ne pas se balancer.",
      "Poignets dans l‚Äôaxe des avant-bras."
    ],
    criteria: [
      "Monter les avant-bras sans avancer les coudes.",
      "Contr√¥ler la descente.",
      "Amplitude adapt√©e √† la mobilit√© de chacun."
    ],
    variations: [
      "Prise marteau (paumes face √† face) pour cibler davantage les avant-bras.",
      "Unilat√©ral (un bras √† la fois) pour travailler la stabilit√©."
    ],
    videoUrl: ""
  },

  {
    name: "R√©troaction avec √©lastique",
    category: "Haut du corps",
    muscles: "Fixateurs d‚Äôomoplates, delto√Ødes post√©rieurs",
    musclesTags: ["√©paules", "omoplates", "haut du dos"],
    equipment: "√âlastique",
    safety: [
      "Debout, jambes semi-fl√©chies, bassin r√©trovers√©.",
      "Abdominaux engag√©s, dos droit.",
      "Ne pas hausser les √©paules."
    ],
    criteria: [
      "Bras le long du corps, tirer les mains vers l‚Äôarri√®re, paumes vers l‚Äôarri√®re.",
      "Serrer les omoplates en fin de mouvement.",
      "Revenir lentement √† la position de d√©part."
    ],
    variations: [
      "Plus facile : r√©duire la tension de l‚Äô√©lastique.",
      "Plus difficile : tenir la contraction 2‚Äì3 s en fin de mouvement."
    ],
    videoUrl: ""
  },

  {
    name: "√âl√©vations lat√©rales avec √©lastique",
    category: "Haut du corps",
    muscles: "Delto√Ødes (√©paules)",
    musclesTags: ["√©paules", "delto√Ødes"],
    equipment: "√âlastique",
    safety: [
      "√âpaules basses, nuque rel√¢ch√©e.",
      "L√©g√®re flexion des coudes.",
      "Ne pas forcer au-del√† du niveau des √©paules si douleur."
    ],
    criteria: [
      "Lever les bras sur les c√¥t√©s jusqu‚Äô√† l‚Äôhorizontale.",
      "Redescendre lentement sans rel√¢cher compl√®tement la tension.",
      "Tronc stable, pas d‚Äô√©lan avec le dos."
    ],
    variations: [
      "Plus facile : √©lastique plus souple ou prise plus proche du centre.",
      "Plus difficile : maintien isom√©trique quelques secondes en haut."
    ],
    videoUrl: ""
  },

  {
    name: "√âl√©vations lat√©rales avec halt√®res",
    category: "Haut du corps",
    muscles: "Delto√Ødes (√©paules)",
    musclesTags: ["√©paules", "delto√Ødes"],
    equipment: "Halt√®res",
    safety: [
      "√âpaules basses (ne pas les hausser).",
      "L√©g√®re flexion des coudes.",
      "Charge adapt√©e pour √©viter de se balancer."
    ],
    criteria: [
      "Lever les bras de chaque c√¥t√© jusqu‚Äô√† l‚Äôhorizontale.",
      "Redescendre lentement.",
      "Tronc stable, gainage l√©ger."
    ],
    variations: [
      "Plus facile : charge plus l√©g√®re, amplitude r√©duite.",
      "Plus difficile : en position assise ou avec pause en haut."
    ],
    videoUrl: ""
  },

  {
    name: "Reverse snow angel",
    category: "Haut du corps",
    muscles: "Haut du dos, √©paules, muscles entre les omoplates",
    musclesTags: ["haut du dos", "√©paules", "omoplates"],
    equipment: "Poids de corps",
    safety: [
      "Allong√© sur le ventre, front pos√© ou regard vers le sol.",
      "Ne pas monter trop haut les √©paules si douleur.",
      "Bas du dos long, abdos engag√©s."
    ],
    criteria: [
      "Bras tendus devant puis ouvrir sur les c√¥t√©s comme un \"ange dans la neige\".",
      "Serrer l√©g√®rement les omoplates en fin de mouvement.",
      "Mouvement lent et contr√¥l√©."
    ],
    variations: [
      "Plus facile : amplitude r√©duite.",
      "Plus difficile : tenir 2 secondes bras ouverts avant de revenir."
    ],
    videoUrl: ""
  },

  {
    name: "Dips triceps sur chaise",
    category: "Haut du corps",
    muscles: "Triceps, √©paules, pectoraux",
    musclesTags: ["triceps", "√©paules", "pectoraux"],
    equipment: "Chaise ou banc stable",
    safety: [
      "Chaise contre un mur, stable.",
      "√âpaules basses, regarder devant.",
      "Ne pas descendre au-del√† de l‚Äôangle confortable des √©paules."
    ],
    criteria: [
      "Mains sur le bord de la chaise, doigts vers l‚Äôavant.",
      "Descendre en fl√©chissant les coudes puis pousser pour remonter.",
      "Dos proche de la chaise (ne pas avancer le bassin)."
    ],
    variations: [
      "Plus facile : genoux fl√©chis, pieds proches.",
      "Plus difficile : jambes tendues ou pied sur√©lev√©."
    ],
    videoUrl: ""
  },

  // ========== ABDOMINAUX / GAINAGE ==========

  {
    name: "La planche (gainage ventral)",
    category: "Abdominaux",
    muscles: "Abdominaux, gainage global, lombaires",
    musclesTags: ["abdos", "gainage", "lombaires"],
    equipment: "Poids de corps",
    safety: [
      "Coudes sous les √©paules.",
      "Corps align√©, ne pas laisser tomber le bassin.",
      "Regard vers le sol."
    ],
    criteria: [
      "Tenir la position sans bouger, respiration calme.",
      "M√™me posture du d√©but √† la fin.",
      "Arr√™ter avant que la technique se d√©grade."
    ],
    variations: [
      "Plus facile : sur les genoux.",
      "Plus difficile : lever une jambe ou un bras."
    ],
    videoUrl: ""
  },

  {
    name: "Le chien-oiseau (bird dog)",
    category: "Abdominaux",
    muscles: "Gainage du tronc, lombaires, fessiers, √©paules",
    musclesTags: ["gainage", "lombaires", "fessiers", "√©paules"],
    equipment: "Poids de corps",
    safety: [
      "Dos plat, hanches au-dessus des genoux.",
      "√âpaules au-dessus des poignets.",
      "Ne pas creuser exag√©r√©ment le bas du dos."
    ],
    criteria: [
      "Allonger un bras et la jambe oppos√©e.",
      "Garder le bassin stable (ne pas tourner).",
      "Revenir puis alterner c√¥t√© droit / gauche."
    ],
    variations: [
      "Plus facile : ne lever que les jambes ou que les bras.",
      "Plus difficile : tenir 3‚Äì4 secondes en √©quilibre."
    ],
    videoUrl: ""
  },

  {
    name: "Battements de jambes / ciseaux",
    category: "Abdominaux",
    muscles: "Grand droit, fl√©chisseurs de hanches, quadriceps",
    musclesTags: ["abdos", "grand droit", "fl√©chisseurs de hanche", "quadriceps"],
    equipment: "Poids de corps",
    safety: [
      "Bas du dos plaqu√© au sol.",
      "Si douleur lombaire : lever davantage les jambes ou les fl√©chir.",
      "Ne pas tirer sur la nuque."
    ],
    criteria: [
      "Nombril aspir√©, omoplates l√©g√®rement d√©coll√©es.",
      "Battement altern√© des jambes en contr√¥lant le mouvement.",
      "Respiration r√©guli√®re."
    ],
    variations: [
      "Version lente pour le contr√¥le.",
      "Version plus dynamique dans un bloc cardio."
    ],
    videoUrl: ""
  },

  {
    name: "Le nageur",
    category: "Abdominaux",
    muscles: "Transverse, bas du dos, fessiers, ischios",
    musclesTags: ["bas du dos", "fessiers", "ischios", "transverse"],
    equipment: "Poids de corps",
    safety: [
      "Allong√© sur le ventre, regard vers le sol.",
      "Abdos engag√©s pour prot√©ger le bas du dos.",
      "Ne pas forcer si douleur lombaire."
    ],
    criteria: [
      "Battements simultan√©s des bras et des jambes.",
      "Mouvement petit et contr√¥l√©, pas de grands gestes brusques.",
      "Respiration fluide."
    ],
    variations: [
      "Plus facile : lever seulement les bras ou seulement les jambes.",
      "Plus difficile : tenir la position en isom√©trie."
    ],
    videoUrl: ""
  },

  {
    name: "Superman",
    category: "Abdominaux",
    muscles: "Bas du dos, fessiers, ischios",
    musclesTags: ["bas du dos", "fessiers", "ischios"],
    equipment: "Poids de corps",
    safety: [
      "Allong√© sur le ventre, bras tendus devant.",
      "Ne pas chercher une extension excessive du dos.",
      "Engager les abdos pour stabiliser."
    ],
    criteria: [
      "Lever bras et jambes en m√™me temps.",
      "Tenir bri√®vement puis redescendre contr√¥l√©.",
      "Respiration r√©guli√®re."
    ],
    variations: [
      "Plus facile : lever seulement le haut ou le bas du corps.",
      "Plus difficile : maintenir plusieurs secondes en haut."
    ],
    videoUrl: ""
  },

  {
    name: "Mountain climbers",
    category: "Abdominaux",
    muscles: "Sangle abdominale, √©paules, cardio",
    musclesTags: ["abdos", "gainage", "cardio"],
    equipment: "Poids de corps",
    safety: [
      "Position de planche bras tendus.",
      "Ne pas laisser le bassin monter ou s‚Äôaffaisser.",
      "Mains sous les √©paules."
    ],
    criteria: [
      "Ramener un genou vers la poitrine puis alterner rapidement.",
      "Garder les pieds l√©gers au sol.",
      "Rythme adapt√© au niveau (du lent au tr√®s dynamique)."
    ],
    variations: [
      "Plus facile : cadence lente.",
      "Plus difficile : en version sprint (30\" intense / 30\" r√©cup)."
    ],
    videoUrl: ""
  },

  {
    name: "Promenade du gainage",
    category: "Abdominaux",
    muscles: "Abdos, √©paules, poignets, gainage global",
    musclesTags: ["gainage", "abdos", "√©paules"],
    equipment: "Poids de corps",
    safety: [
      "Partir en planche bras tendus.",
      "Pas de creux dans le bas du dos.",
      "Bien r√©partir le poids entre mains et pieds."
    ],
    criteria: [
      "Marcher vers l‚Äôavant ou sur les c√¥t√©s en gardant le tronc stable.",
      "Petits pas pour limiter les √†-coups.",
      "Revenir progressivement √† la position de d√©part."
    ],
    variations: [
      "Plus facile : distance de marche r√©duite.",
      "Plus difficile : marcher autour d‚Äôun rep√®re (c√¥ne, tapis‚Ä¶)."
    ],
    videoUrl: ""
  },

  {
    name: "Planche creuse",
    category: "Abdominaux",
    muscles: "Grand droit, transverse, fl√©chisseurs de hanches",
    musclesTags: ["abdos", "grand droit", "transverse"],
    equipment: "Poids de corps",
    safety: [
      "Bas du dos coll√© au sol.",
      "Si douleur lombaire : r√©duire l‚Äôamplitude des jambes.",
      "Ne pas bloquer la respiration."
    ],
    criteria: [
      "Bras tendus derri√®re la t√™te, jambes tendues ou fl√©chies.",
      "Former une \"banane\" en d√©collant l√©g√®rement √©paules et jambes.",
      "Tenir la position en gardant le ventre rentr√©."
    ],
    variations: [
      "Plus facile : une seule jambe tendue ou genoux fl√©chis.",
      "Plus difficile : petits battements de bras et de jambes."
    ],
    videoUrl: ""
  },

  {
    name: "Insecte mort (dead bug)",
    category: "Abdominaux",
    muscles: "Transverse, grand droit, fl√©chisseurs de hanches",
    musclesTags: ["abdos", "transverse", "grand droit"],
    equipment: "Poids de corps",
    safety: [
      "Bas du dos plaqu√© au sol.",
      "Ne pas aller trop bas avec la jambe si le dos se d√©colle.",
      "Respiration r√©guli√®re."
    ],
    criteria: [
      "Bras vers le plafond, hanches et genoux √† 90¬∞.",
      "Descendre bras et jambe oppos√©s sans d√©coller le bas du dos.",
      "Revenir et alterner les c√¥t√©s."
    ],
    variations: [
      "Plus facile : ne bouger que les jambes.",
      "Plus difficile : ralentir fortement la descente."
    ],
    videoUrl: ""
  },

  {
    name: "Lev√©s de jambe lat√©raux",
    category: "Abdominaux",
    muscles: "Obliques, moyens fessiers, gainage lat√©ral",
    musclesTags: ["obliques", "gainage", "fessiers"],
    equipment: "Poids de corps",
    safety: [
      "Allong√© sur le c√¥t√©, t√™te align√©e avec la colonne.",
      "Ne pas tirer sur le cou.",
      "Bassin stable, ne pas rouler vers l‚Äôavant ou l‚Äôarri√®re."
    ],
    criteria: [
      "Lever la jambe du dessus vers le plafond, contr√¥le de la descente.",
      "Pied l√©g√®rement tourn√© vers l‚Äôint√©rieur pour cibler le moyen fessier.",
      "Respiration fluide."
    ],
    variations: [
      "Plus facile : amplitude r√©duite.",
      "Plus difficile : maintenir quelques secondes en haut."
    ],
    videoUrl: ""
  },

  {
    name: "Planche lat√©rale",
    category: "Abdominaux",
    muscles: "Obliques, gainage lat√©ral",
    musclesTags: ["abdos", "obliques", "gainage"],
    equipment: "Poids de corps",
    safety: [
      "Coude sous l‚Äô√©paule.",
      "Bassin align√© avec le reste du corps.",
      "Ne pas laisser tomber la hanche."
    ],
    criteria: [
      "Corps align√©, jambes tendues ou fl√©chies.",
      "Maintenir la position sans tremblements excessifs.",
      "Respiration ma√Ætris√©e."
    ],
    variations: [
      "Version sur les genoux.",
      "Plus difficile : lever la jambe du dessus."
    ],
    videoUrl: ""
  },

  {
    name: "Crunch",
    category: "Abdominaux",
    muscles: "Grand droit (haut des abdos)",
    musclesTags: ["abdos", "grand droit"],
    equipment: "Poids de corps",
    safety: [
      "Bas du dos en contact avec le sol.",
      "Ne pas tirer sur la nuque.",
      "Mont√©e courte, sans s‚Äôasseoir compl√®tement."
    ],
    criteria: [
      "Enrouler le buste en expirant.",
      "Redescendre lentement en inspirant.",
      "Regard vers le plafond."
    ],
    variations: [
      "Avec les pieds sur√©lev√©s.",
      "Avec charge l√©g√®re tenue sur la poitrine."
    ],
    videoUrl: ""
  },

  {
    name: "Russian twist",
    category: "Abdominaux",
    muscles: "Obliques, grand droit",
    musclesTags: ["obliques", "abdos"],
    equipment: "Poids de corps ou charge l√©g√®re",
    safety: [
      "Dos droit, buste l√©g√®rement inclin√© vers l‚Äôarri√®re.",
      "Ne pas arrondir exag√©r√©ment le bas du dos.",
      "Regard vers l‚Äôavant."
    ],
    criteria: [
      "Tourner le buste de droite √† gauche en contr√¥lant.",
      "Les mains suivent le mouvement (avec ou sans charge).",
      "Pieds au sol ou l√©g√®rement d√©coll√©s selon le niveau."
    ],
    variations: [
      "Plus facile : pieds au sol.",
      "Plus difficile : charge dans les mains et pieds d√©coll√©s."
    ],
    videoUrl: ""
  },

  {
    name: "Chandelle",
    category: "Abdominaux",
    muscles: "Abdos bas, fl√©chisseurs de hanches",
    musclesTags: ["abdos", "grand droit"],
    equipment: "Poids de corps",
    safety: [
      "Bras le long du corps pour se stabiliser.",
      "Ne pas retomber sur le dos en redescendant.",
      "Contr√¥ler la mont√©e, ne pas donner de coups de bassin violents."
    ],
    criteria: [
      "Lever les jambes √† la verticale puis pousser le bassin vers le plafond.",
      "Revenir en contr√¥lant la descente vert√®bre par vert√®bre.",
      "Respiration ma√Ætris√©e."
    ],
    variations: [
      "Plus facile : lever uniquement les jambes sans d√©coller le bassin.",
      "Plus difficile : encha√Æner plusieurs chandelles sans reposer compl√®tement."
    ],
    videoUrl: ""
  },

  // ========== BAS DU CORPS ==========

  {
    name: "Squats",
    category: "Bas du corps",
    muscles: "Quadriceps, fessiers, ischios-jambiers, gainage",
    musclesTags: ["quadriceps", "fessiers", "jambes", "ischios"],
    equipment: "Poids de corps ou halt√®res",
    safety: [
      "Genoux align√©s avec les pointes de pieds.",
      "Dos droit, regard vers l‚Äôavant.",
      "Talons au sol pendant tout le mouvement."
    ],
    criteria: [
      "Hanches qui reculent comme pour s‚Äôasseoir.",
      "Cuisses au moins parall√®les au sol si possible.",
      "Pousser dans les talons pour remonter."
    ],
    variations: [
      "Plus facile : squat partiel (amplitude r√©duite).",
      "Plus difficile : squat saut√© ou avec halt√®res."
    ],
    videoUrl: ""
  },

  {
    name: "Fentes avant / arri√®re",
    category: "Bas du corps",
    muscles: "Quadriceps, fessiers, ischios-jambiers",
    musclesTags: ["fessiers", "quadriceps", "ischios", "jambes"],
    equipment: "Poids de corps ou halt√®res",
    safety: [
      "Genou avant align√©, ne pas rentrer vers l‚Äôint√©rieur.",
      "Tronc droit, regarder devant.",
      "Ne pas cogner le genou arri√®re au sol."
    ],
    criteria: [
      "Faire un grand pas vers l‚Äôavant ou vers l‚Äôarri√®re, descendre √† 90¬∞/90¬∞.",
      "Pousser fort sur la jambe avant pour revenir.",
      "Alternance jambe droite / jambe gauche."
    ],
    variations: [
      "Plus facile : fentes statiques.",
      "Plus difficile : fentes saut√©es."
    ],
    videoUrl: ""
  },

  {
    name: "Fentes crois√©es",
    category: "Bas du corps",
    muscles: "Fessiers, quadriceps, adducteurs",
    musclesTags: ["fessiers", "quadriceps", "adducteurs"],
    equipment: "Poids de corps",
    safety: [
      "Garder le buste droit.",
      "Genou avant align√© sur la pointe de pied.",
      "Descente contr√¥l√©e pour prot√©ger les genoux."
    ],
    criteria: [
      "Croiser une jambe derri√®re l‚Äôautre en diagonale.",
      "Descendre jusqu‚Äô√† sentir le travail dans les fessiers.",
      "Revenir en poussant dans la jambe avant."
    ],
    variations: [
      "Plus facile : amplitude r√©duite.",
      "Plus difficile : ajouter des halt√®res."
    ],
    videoUrl: ""
  },

  {
    name: "La chaise (wall sit)",
    category: "Bas du corps",
    muscles: "Quadriceps, fessiers, gainage",
    musclesTags: ["quadriceps", "fessiers", "gainage"],
    equipment: "Mur",
    safety: [
      "Dos plaqu√© contre le mur.",
      "Genoux √† 90¬∞ au-dessus des chevilles.",
      "Ne pas rester si douleur aux genoux."
    ],
    criteria: [
      "Tenir la position sans bouger.",
      "R√©partition du poids sur toute la plante des pieds.",
      "Respiration calme."
    ],
    variations: [
      "Plus facile : angle de genou > 90¬∞ (plus haut).",
      "Plus difficile : tenir un poids, lever une jambe."
    ],
    videoUrl: ""
  },

  {
    name: "Leg curl au sol",
    category: "Bas du corps",
    muscles: "Ischios-jambiers, fessiers",
    musclesTags: ["ischios", "fessiers"],
    equipment: "Poids de corps (ou serviette / rouleau sous les pieds)",
    safety: [
      "Allong√© sur le dos, pieds sur support glissant ou sur√©lev√©.",
      "Ne pas cambrer exag√©r√©ment le bas du dos.",
      "Abdos engag√©s."
    ],
    criteria: [
      "Monter le bassin puis ramener les talons vers les fessiers.",
      "Revenir en contr√¥lant l‚Äôextension.",
      "Respiration fluide."
    ],
    variations: [
      "Plus facile : amplitude r√©duite.",
      "Plus difficile : en unilat√©ral (une jambe)."
    ],
    videoUrl: ""
  },

  {
    name: "Step-up sur banc ou marche",
    category: "Bas du corps",
    muscles: "Quadriceps, fessiers, mollets",
    musclesTags: ["quadriceps", "fessiers", "mollets"],
    equipment: "Banc, caisse ou marche stable",
    safety: [
      "Support stable et non glissant.",
      "Genou dans l‚Äôaxe du pied.",
      "Monter compl√®tement sans se pencher trop en avant."
    ],
    criteria: [
      "Monter sur le support en poussant dans le talon de la jambe d‚Äôappui.",
      "Redescendre en contr√¥lant.",
      "Alterner jambe droite / gauche."
    ],
    variations: [
      "Plus facile : support plus bas.",
      "Plus difficile : avec halt√®res ou mont√©e explosive."
    ],
    videoUrl: ""
  },

  {
    name: "Donkey kick",
    category: "Bas du corps",
    muscles: "Fessiers, ischios, gainage",
    musclesTags: ["fessiers", "ischios", "gainage"],
    equipment: "Poids de corps",
    safety: [
      "Position quadrup√©die (4 appuis), dos plat.",
      "Ne pas creuser le bas du dos.",
      "Regard vers le sol."
    ],
    criteria: [
      "Pousser le talon vers le plafond en gardant le genou fl√©chi.",
      "Revenir sans toucher le sol avec le genou si possible.",
      "Faire toutes les r√©p√©titions d‚Äôun c√¥t√© puis de l‚Äôautre."
    ],
    variations: [
      "Plus difficile : √©lastique autour des cuisses.",
      "Plus facile : amplitude r√©duite."
    ],
    videoUrl: ""
  },

  {
    name: "Fire hydrant",
    category: "Bas du corps",
    muscles: "Fessiers moyens, abducteurs, gainage",
    musclesTags: ["fessiers", "abducteurs", "gainage"],
    equipment: "Poids de corps",
    safety: [
      "Dos plat, abdos engag√©s.",
      "Ne pas tourner tout le bassin.",
      "Mouvement contr√¥l√©, sans √†-coup."
    ],
    criteria: [
      "Abduction de la hanche : lever le genou sur le c√¥t√©.",
      "Revenir sans reposer compl√®tement.",
      "R√©p√©ter puis changer de c√¥t√©."
    ],
    variations: [
      "Plus difficile : √©lastique au-dessus des genoux.",
      "Plus facile : amplitude r√©duite."
    ],
    videoUrl: ""
  },

  {
    name: "Pont fessier au sol",
    category: "Bas du corps",
    muscles: "Fessiers, ischios, lombaires",
    musclesTags: ["fessiers", "ischios", "lombaires"],
    equipment: "Poids de corps ou charge sur le bassin",
    safety: [
      "Pieds √† plat, largeur bassin.",
      "Ne pas hypercambrer le bas du dos en haut.",
      "Regard vers le plafond."
    ],
    criteria: [
      "Monter le bassin jusqu‚Äô√† aligner cuisses / bassin / tronc.",
      "Contracter fortement les fessiers en haut.",
      "Redescendre lentement sans reposer compl√®tement."
    ],
    variations: [
      "Unilat√©ral (une jambe en l‚Äôair).",
      "Avec √©lastique autour des genoux pour plus de travail lat√©ral."
    ],
    videoUrl: ""
  },

  {
    name: "Extension des mollets",
    category: "Bas du corps",
    muscles: "Mollets (triceps sural)",
    musclesTags: ["mollets", "jambes"],
    equipment: "Poids de corps (ou marche)",
    safety: [
      "Se tenir √† un support si besoin d‚Äô√©quilibre.",
      "Ne pas rebondir violemment.",
      "Amorti souple en redescendant."
    ],
    criteria: [
      "Monter sur la pointe des pieds.",
      "Marquer une petite pause en haut.",
      "Redescendre lentement jusqu‚Äôaux talons."
    ],
    variations: [
      "Plus difficile : sur une jambe.",
      "Plus difficile encore : sur une marche pour plus d‚Äôamplitude."
    ],
    videoUrl: ""
  },

  // ========== CARDIO ==========

  {
    name: "Mont√©es de genoux sur place",
    category: "Cardio",
    muscles: "Quadriceps, fl√©chisseurs de hanche, cardio",
    musclesTags: ["cardio", "quadriceps", "course"],
    equipment: "Poids de corps",
    safety: [
      "Atterrissage souple sur l‚Äôavant du pied.",
      "Regard droit devant.",
      "Ne pas se pencher trop en arri√®re."
    ],
    criteria: [
      "Genoux mont√©s √† peu pr√®s √† hauteur de hanche.",
      "Bras actifs (comme en course).",
      "Rythme r√©gulier adapt√© au niveau."
    ],
    variations: [
      "Version lente en √©chauffement.",
      "Version tr√®s dynamique en intervalle (30\" tr√®s intense / 30\" r√©cup)."
    ],
    videoUrl: ""
  },

  {
    name: "Talons-fesses sur place",
    category: "Cardio",
    muscles: "Ischios-jambiers, fessiers, cardio",
    musclesTags: ["cardio", "ischios", "fessiers"],
    equipment: "Poids de corps",
    safety: [
      "Rester l√©ger sur les appuis.",
      "Ne pas exag√©rer le mouvement du buste.",
      "Regard vers l‚Äôavant."
    ],
    criteria: [
      "Talons qui viennent fr√¥ler les fesses.",
      "Cadence r√©guli√®re.",
      "Bras en mouvement pour accompagner."
    ],
    variations: [
      "Peut √™tre int√©gr√© en √©chauffement.",
      "En alternance avec mont√©es de genoux."
    ],
    videoUrl: ""
  },

  {
    name: "Jumping jacks",
    category: "Cardio",
    muscles: "Cardio global, adducteurs, abducteurs, √©paules",
    musclesTags: ["cardio", "adducteurs", "abducteurs", "√©paules"],
    equipment: "Poids de corps",
    safety: [
      "Amortir les r√©ceptions.",
      "Ne pas laisser les genoux rentrer vers l‚Äôint√©rieur.",
      "Adapter la vitesse au niveau de chacun."
    ],
    criteria: [
      "Ouverture/fermeture des jambes coordonn√©e avec les bras.",
      "Posture droite, regard devant.",
      "Rythme r√©gulier sur toute la dur√©e."
    ],
    variations: [
      "Version sans saut (pas lat√©raux) pour les √©l√®ves fragiles ou en reprise.",
      "Version en tempo rapide pour travail cardio intense."
    ],
    videoUrl: ""
  },

  {
    name: "Burpees",
    category: "Cardio",
    muscles: "Cardio global, pectoraux, √©paules, jambes",
    musclesTags: ["cardio", "pectoraux", "√©paules", "jambes"],
    equipment: "Poids de corps",
    safety: [
      "Ne pas rel√¢cher le dos lors de la phase en planche.",
      "Adapter l‚Äôamplitude du saut √† son niveau.",
      "√âviter si douleurs importantes de dos ou genou."
    ],
    criteria: [
      "Descendre au sol, passer en planche, revenir et sauter bras vers le plafond.",
      "Mouvement fluide, sans temps morts.",
      "Rythme adapt√© au niveau."
    ],
    variations: [
      "Plus facile : sans saut, ni pompe.",
      "Plus difficile : burpees avec pompe compl√®te."
    ],
    videoUrl: ""
  },

  {
    name: "Sauts √† la corde",
    category: "Cardio",
    muscles: "Mollets, cardio, coordination",
    musclesTags: ["cardio", "mollets", "coordination"],
    equipment: "Corde √† sauter (ou sans corde)",
    safety: [
      "Surface plane et d√©gag√©e.",
      "Petits sauts, atterrissage sur l‚Äôavant du pied.",
      "Genoux l√©g√®rement fl√©chis."
    ],
    criteria: [
      "Sauts rythmiques, sans trop monter les genoux.",
      "Poignets qui tournent, √©paules rel√¢ch√©es.",
      "Capacit√© √† tenir sur la dur√©e choisie."
    ],
    variations: [
      "Sans corde : imitation du mouvement de bras et de jambes.",
      "Double sauts ou variations de rythme pour les plus √† l‚Äôaise."
    ],
    videoUrl: ""
  },

  {
    name: "Course sur place",
    category: "Cardio",
    muscles: "Cardio global, membres inf√©rieurs",
    musclesTags: ["cardio", "course"],
    equipment: "Poids de corps",
    safety: [
      "Posture droite (ne pas s‚Äôaffaisser).",
      "Amortir les appuis.",
      "Adapter l‚Äôintensit√© √† la s√©ance (√©chauffement vs travail intense)."
    ],
    criteria: [
      "Cadence r√©guli√®re.",
      "Bras actifs pour accompagner.",
      "Possibilit√© de varier l‚Äôintensit√© selon les consignes."
    ],
    variations: [
      "Course sur place avec changements de direction (visuels/consignes).",
      "Sprints courts sur place altern√©s avec marche sur place."
    ],
    videoUrl: ""
  }
];

function getCategoryBadgeClass(category) {
  switch (category) {
    case "Haut du corps": return "category-haut";
    case "Bas du corps": return "category-bas";
    case "Abdominaux": return "category-abdos";
    case "Cardio": return "category-cardio";
    default: return "";
  }
}

function renderExerciseList() {
  const listEl = document.getElementById("exerciseList");
  if (!listEl) return;

  const catFilter = document.getElementById("exerciseCategoryFilter").value || "ALL";
  const search = (document.getElementById("exerciseSearch").value || "").toLowerCase().trim();

  const filtered = EXERCISES.filter(ex => {
    if (catFilter !== "ALL" && ex.category !== catFilter) return false;

    if (!search) return true;

    const haystack = [
      ex.name,
      ex.muscles,
      ...(ex.musclesTags || [])
    ].join(" ").toLowerCase();

    return haystack.includes(search);
  });

  if (filtered.length === 0) {
    listEl.innerHTML = `<p class="muted">Aucun exercice ne correspond √† ta recherche.</p>`;
    return;
  }

  listEl.innerHTML = filtered.map((ex) => `
    <div class="exercise-item" data-ex-name="${ex.name}">
      <div class="exercise-title-row">
        <div class="exercise-name">${ex.name}</div>
        <div class="exercise-badges">
          <span class="exercise-badge ${getCategoryBadgeClass(ex.category)}">${ex.category}</span>
          <span class="exercise-badge">${ex.equipment}</span>
        </div>
      </div>
      <div class="exercise-muscles">
        Muscles : ${ex.muscles}
      </div>
    </div>
  `).join("");

  listEl.querySelectorAll(".exercise-item").forEach(item => {
    const exName = item.dataset.exName;
    item.addEventListener("click", () => {
      const ex = EXERCISES.find(e => e.name === exName);
      if (ex) openExerciseModal(ex);
    });
  });
}

function openExerciseModal(ex) {
  document.getElementById("exerciseTitle").textContent = ex.name;
  document.getElementById("exerciseCategory").textContent = ex.category;
  document.getElementById("exerciseMuscles").textContent = ex.muscles;

  const equipmentLine = document.getElementById("exerciseEquipmentLine");
  equipmentLine.textContent = ex.equipment ? `Mat√©riel : ${ex.equipment}` : "";

  document.getElementById("exerciseSafety").innerHTML =
    (ex.safety || []).map(s => `<li>${s}</li>`).join("");

  document.getElementById("exerciseCriteria").innerHTML =
    (ex.criteria || []).map(c => `<li>${c}</li>`).join("");

  document.getElementById("exerciseVariations").innerHTML =
    (ex.variations || []).map(v => `<li>${v}</li>`).join("");

  const link = document.getElementById("exerciseVideoLink");
  if (ex.videoUrl) {
    link.href = ex.videoUrl;
    link.style.display = "inline-flex";
  } else {
    link.style.display = "none";
  }

  document.getElementById("exerciseModal").style.display = "flex";
}

function closeExerciseModal() {
  const modal = document.getElementById("exerciseModal");
  if (modal) modal.style.display = "none";
}

  const MUSCLES_INFO = [
    { name: "Biceps", action: "Flexion de l'avant-bras" },
    { name: "Triceps", action: "Extension de l'avant-bras" },
    { name: "Delto√Øde", action: "√âl√©vation / rotation du bras" },
    { name: "Trap√®ze", action: "√âl√©vation de l'√©paule" },
    { name: "Adducteurs", action: "Adduction de la jambe" },
    { name: "Pectoraux", action: "Rapprochent les bras" },
    { name: "Quadriceps", action: "Extension du genou" },
    { name: "Ischios-jambiers", action: "Flexion de la jambe" },
    { name: "Grand fessier", action: "Extension de la cuisse" },
    { name: "Abdominaux", action: "Flexion / rotation du tronc" },
    { name: "Mollets", action: "Extension de la cheville" },
    { name: "Lombaires", action: "Extension du tronc" },
    { name: "Grand dorsal", action: "Fermeture bras-tronc" },
    { name: "Abducteurs", action: "Abduction de la jambe" }
  ];

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { classes: [] };
      const data = JSON.parse(raw);
      if (!data.classes) data.classes = [];
      return data;
    } catch {
      return { classes: [] };
    }
  }
// Sauvegarde locale + envoi √† Firebase
function saveData() {
  const json = JSON.stringify(appState.data);
  localStorage.setItem(STORAGE_KEY, json);
  saveToFirebase(appState.data);
}
// --- S√©curit√© / r√©paration des donn√©es classes/√©l√®ves ---

function backupBeforeRewrite(data, location = "unknown") {
  const timestamp = new Date().toISOString();
  try {
    localStorage.setItem(
      "backup_" + timestamp + "_" + location,
      JSON.stringify(data)
    );
  } catch (e) {
    console.warn("Impossible de cr√©er une sauvegarde locale :", e);
  }
}

function ensureClassHasStudentsArray(classe, location = "") {
  if (!classe) return;
  if (!classe.students || !Array.isArray(classe.students)) {
    console.warn("‚ö†Ô∏è Correction automatique : classe sans tableau d'√©l√®ves. (Lieu : " + location + ")");
    // on sauvegarde l‚Äô√©tat actuel avant correction
    backupBeforeRewrite(appState.data, location);
    // on r√©pare
    classe.students = [];
  }
}

// Envoi des donn√©es √† Firebase (mode tr√®s simple)
function saveToFirebase(data) {
  fetch(FIREBASE_URL, {
    method: "PUT",                 // on remplace tout le document
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).catch((err) => {
    console.log("Erreur d‚Äôenvoi Firebase (non bloquant) :", err);
  });
}
// R√©cup√©ration depuis Firebase au d√©marrage
async function syncFromFirebase() {
  try {
    const res = await fetch(FIREBASE_URL);
    if (!res.ok) throw new Error("R√©ponse HTTP non OK");

    const remoteData = await res.json();

    // Si des donn√©es existent sur Firebase, on les utilise
    if (remoteData && typeof remoteData === "object" && Array.isArray(remoteData.classes)) {
      appState.data = remoteData;
      // On met aussi en cache local
      localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.data));
    }
  } catch (err) {
    console.log("Impossible de charger depuis Firebase, utilisation des donn√©es locales :", err);
  }
}

  function createId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
  }

  const appState = {
    data: loadData(),
    selectedClassId: null,
    selectedStudentId: null
  };

  const viewClasses  = document.getElementById("view-classes");
  const viewStudents = document.getElementById("view-students");
  const viewCarnet   = document.getElementById("view-carnet");

  function showView(name) {
    viewClasses.style.display  = name === "classes" ? "block" : "none";
    viewStudents.style.display = name === "students" ? "block" : "none";
    viewCarnet.style.display   = name === "carnet"   ? "block" : "none";
  }

  const selectClassEl = document.getElementById("selectClass");
  const newClassNameEl = document.getElementById("newClassName");
  const btnAddClass = document.getElementById("btnAddClass");
  const btnDeleteClass = document.getElementById("btnDeleteClass");
  const btnConfigTeams = document.getElementById("btnConfigTeams");
btnConfigTeams.addEventListener("click", goToStudentsView);

  const goToStudentsText = document.getElementById("goToStudentsText");

  function renderClassSelect() {
    const classes = appState.data.classes;
    selectClassEl.innerHTML = "";
    if (classes.length === 0) {
      const opt = document.createElement("option");
      opt.textContent = "Aucune classe pour l'instant";
      opt.value = "";
      selectClassEl.appendChild(opt);
      appState.selectedClassId = null;
      return;
    }
    classes.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      selectClassEl.appendChild(opt);
    });
    const exists = classes.find(c => c.id === appState.selectedClassId);
    if (exists) {
      selectClassEl.value = appState.selectedClassId;
    } else {
      appState.selectedClassId = classes[0].id;
      selectClassEl.value = classes[0].id;
    }
  }

  function addClass() {
    const name = newClassNameEl.value.trim();
    if (!name) {
      alert("Merci de saisir un nom de classe (ex : 206).");
      return;
    }
    const newClass = { id: createId(), name, students: [] };
    appState.data.classes.push(newClass);
    appState.selectedClassId = newClass.id;
    newClassNameEl.value = "";
    saveData();
    renderClassSelect();
  }

function deleteClass() {
  const id = appState.selectedClassId;
  if (!id) {
    alert("Aucune classe s√©lectionn√©e.");
    return;
  }

  // Demande du code enseignant
  const code = prompt("Code de suppression (enseignant) :");
  if (code === null) {
    // Annul√©
    return;
  }
  if (code !== DELETE_CODE) {
    alert("Code incorrect. Suppression annul√©e.");
    return;
  }

  const classe = appState.data.classes.find(c => c.id === id);
  if (!classe) return;

  if (!confirm(`Supprimer d√©finitivement la classe "${classe.name}" et tous les carnets associ√©s ?`)) return;

  appState.data.classes = appState.data.classes.filter(c => c.id !== id);
  appState.selectedClassId = null;
  saveData();
  renderClassSelect();
}


  function goToStudentsView() {
    const id = appState.selectedClassId;
    if (!id) {
      alert("Choisis d'abord une classe.");
      return;
    }
    renderStudents();
    showView("students");
  }

  const studentsClassNameEl = document.getElementById("studentsClassName");
  const newStudentNameEl = document.getElementById("newStudentName");
  const btnAddStudent = document.getElementById("btnAddStudent");
  const studentsListEl = document.getElementById("studentsList");
  const backToClassesEl = document.getElementById("backToClasses");

  function getSelectedClass() {
    return appState.data.classes.find(c => c.id === appState.selectedClassId) || null;
  }

  function renderStudents() {
  const classe = getSelectedClass();
  if (!classe) return;

  // ‚úÖ on s'assure que la classe a bien un tableau d'√©l√®ves
  ensureClassHasStudentsArray(classe, "renderStudents()");

  studentsClassNameEl.textContent = classe.name;
  studentsListEl.innerHTML = "";


    if (classe.students.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.className = "muted";
      td.textContent = "Aucun √©l√®ve pour l'instant.";
      tr.appendChild(td);
      studentsListEl.appendChild(tr);
      return;
    }

    classe.students.slice().sort((a, b) => a.name.localeCompare(b.name, "fr"))
      .forEach((student, index) => {
        const tr = document.createElement("tr");

        const tdIndex = document.createElement("td");
        tdIndex.textContent = index + 1;

        const tdName = document.createElement("td");
        const btnName = document.createElement("button");
        btnName.className = "student-name-btn";
        btnName.textContent = student.name;
        btnName.addEventListener("click", () => openCarnet(student.id));
        tdName.appendChild(btnName);

        const tdOpen = document.createElement("td");
        const openBtn = document.createElement("button");
        openBtn.className = "btn btn-sm btn-secondary";
        openBtn.textContent = "Ouvrir mon carnet ‚ûú";
        openBtn.addEventListener("click", () => openCarnet(student.id));
        tdOpen.appendChild(openBtn);

        const tdDelete = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.textContent = "‚úï";
        delBtn.title = "Supprimer l'√©l√®ve";
        delBtn.addEventListener("click", () => removeStudent(student.id));
        tdDelete.appendChild(delBtn);

        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdOpen);
        tr.appendChild(tdDelete);
        studentsListEl.appendChild(tr);
      });
  }

  function addStudent() {
    const name = newStudentNameEl.value.trim();
    if (!name) {
      alert("Merci de saisir un pr√©nom.");
      return;
    }
    const classe = getSelectedClass();
    if (!classe) return;
    classe.students.push({ id: createId(), name, carnet: null });
    newStudentNameEl.value = "";
    newStudentNameEl.focus();
    saveData();
    renderStudents();
  }

  function removeStudent(studentId) {
  const classe = getSelectedClass();
  if (!classe) return;
  const student = classe.students.find(s => s.id === studentId);
  if (!student) return;

  // Demande du code enseignant
  const code = prompt(`Code de suppression (enseignant) pour effacer le carnet de ${student.name} :`);
  if (code === null) {
    // Annul√©
    return;
  }
  if (code !== DELETE_CODE) {
    alert("Code incorrect. Suppression annul√©e.");
    return;
  }

  if (!confirm(`Supprimer le carnet de ${student.name} ?`)) return;

  classe.students = classe.students.filter(s => s.id !== studentId);
  saveData();
  renderStudents();
}


  const carnetStudentNameEl = document.getElementById("carnetStudentName");
  const carnetClassNameEl = document.getElementById("carnetClassName");
  const backToStudentsEl = document.getElementById("backToStudents");
  const lessonsContainerEl = document.getElementById("lessonsContainer");
  const musclesSheetContainerEl = document.getElementById("musclesSheetContainer");
  const selfEvalNoteEl = document.getElementById("selfEvalNote");
  const selfEvalSummaryEl = document.getElementById("selfEvalSummary");

 function lessonTemplate(index) {
  return {
    number: index + 1,
    date: "",
    mobile: "",
    stateLevel: "5",

    // Champs g√©n√©riques (utilis√©s dans toutes les le√ßons)
    warmup: "",
    seriesCount: "",
    intensity: "",
    recovery: "",

    // üîµ Champs sp√©cifiques √† la LE√áON 3 (5 √©tapes)
    step1Testing: "",
    step2Warmup: "",       // on liera aussi ce champ √† "warmup"
    step3Progression: "",
    step4ChargeCorrectif: "",
    step5Finish: "",

    effortLevel: "",
    musclesLevel: "",
    breathLevel: "",
    heatLevel: "",
    // √âtape 4 ‚Äì observation squat
    step4Dos: "",
    step4Equilibre: "",
    step4Talons: "",
    step4Amplitude: "",
    step4Genoux: "",
    step4Rer: "",

    bilan: "",
    observerName: "",
    chronoSeconds: 0,
    validated: false,
    fmsDeepSquatLevel: "",
    fmsDeepSquatNotes: "",
    squatProgressionLevel: "",     // niveau atteint dans la cha√Æne de progression (1 √† 5)
    squatProgressionNotes: "",     // remarques de l'√©l√®ve sur cette progression

    exercises: Array.from({ length: EXO_LINES }, () => ({
      muscles: "",
      name: "",
      posture: "",
      amplitude: "",
      breathing: "",
      remark: ""
    }))
  };
}


  function ensureCarnet(student) {
    if (!student.carnet) {
      student.carnet = { lessons: [], musclesSheet: null, selfEval: null };
    }
    if (!student.carnet.lessons || student.carnet.lessons.length !== LESSON_COUNT) {
      const existing = student.carnet.lessons || [];
      const lessons = [];
      for (let i = 0; i < LESSON_COUNT; i++) {
        lessons[i] = Object.assign(lessonTemplate(i), existing[i] || {});
      }
      student.carnet.lessons = lessons;
    } else {
      student.carnet.lessons = student.carnet.lessons.map((l, i) =>
        Object.assign(lessonTemplate(i), l)
      );
    }

    if (!student.carnet.musclesSheet || !student.carnet.musclesSheet.lines ||
        student.carnet.musclesSheet.lines.length !== MUSCLES_INFO.length) {
      const old = (student.carnet.musclesSheet && student.carnet.musclesSheet.lines) || [];
      const lines = [];
      for (let i = 0; i < MUSCLES_INFO.length; i++) {
        lines[i] = old[i] || { num: "", exercise: "" };
      }
      student.carnet.musclesSheet = { lines };
    }

    if (!student.carnet.selfEval) {
      student.carnet.selfEval = {
        afl1e1: "",
        afl1e2: "",
        afl2: "",
        afl3: "",
        note: ""
      };
    }
  }

// --------- Gestion du chronom√®tre par le√ßon ---------
const lessonTimers = {}; // { [lessonIndex]: { intervalId, startTime } }

function formatSeconds(total) {
  total = total || 0;
  const h = Math.floor(total / 3600);
  const m = Math.floor((total % 3600) / 60);
  const s = total % 60;

  const pad = (n) => String(n).padStart(2, "0");
  if (h > 0) {
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  return `${pad(m)}:${pad(s)}`;
}

function updateTimerDisplayFor(lessonIndex) {
  const student = getSelectedStudent();
  if (!student || !student.carnet || !student.carnet.lessons[lessonIndex]) return;
  const lesson = student.carnet.lessons[lessonIndex];

  const el = document.getElementById(`timer_${lessonIndex}`);
  if (!el) return;
  el.textContent = formatSeconds(lesson.chronoSeconds || 0);
}

function onTimerStart(e) {
  const student = getSelectedStudent();
  if (!student || !student.carnet) return;

  const lessonIndex = parseInt(e.target.dataset.lesson, 10);
  if (isNaN(lessonIndex) || !student.carnet.lessons[lessonIndex]) return;
  const lesson = student.carnet.lessons[lessonIndex];

  // On arr√™te un √©ventuel ancien chrono pour cette le√ßon
  if (lessonTimers[lessonIndex] && lessonTimers[lessonIndex].intervalId) {
    clearInterval(lessonTimers[lessonIndex].intervalId);
  }

  const startTime = Date.now() / 1000 - (lesson.chronoSeconds || 0);

  const intervalId = setInterval(() => {
    const now = Date.now() / 1000;
    lesson.chronoSeconds = Math.max(0, Math.floor(now - startTime));
    updateTimerDisplayFor(lessonIndex);
    saveData();
  }, 1000);

  lessonTimers[lessonIndex] = { intervalId, startTime };
  updateTimerDisplayFor(lessonIndex);
}

function onTimerStop(e) {
  const student = getSelectedStudent();
  if (!student || !student.carnet) return;

  const lessonIndex = parseInt(e.target.dataset.lesson, 10);
  if (isNaN(lessonIndex) || !student.carnet.lessons[lessonIndex]) return;

  if (lessonTimers[lessonIndex] && lessonTimers[lessonIndex].intervalId) {
    clearInterval(lessonTimers[lessonIndex].intervalId);
    delete lessonTimers[lessonIndex];
  }
  saveData();
  updateTimerDisplayFor(lessonIndex);
}

function openCarnet(studentId) {
  const classe = getSelectedClass();
  if (!classe) return;

  // ‚úÖ on s√©curise aussi ici
  ensureClassHasStudentsArray(classe, "openCarnet()");

  const student = classe.students.find(s => s.id === studentId);
  if (!student) return;

  ensureCarnet(student);
  appState.selectedStudentId = studentId;

  carnetStudentNameEl.textContent = student.name;
  carnetClassNameEl.textContent = `Classe ${classe.name}`;

  renderMusclesSheet(student);
  renderLessons(student);
  setActiveTab("lessons");
  syncSelfEvalUI(student);

  showView("carnet");
  saveData();
}

  function getSelectedStudent() {
    const classe = getSelectedClass();
    if (!classe) return null;
    return classe.students.find(s => s.id === appState.selectedStudentId) || null;
  }

  function renderMusclesSheet(student) {
    const lines = student.carnet.musclesSheet.lines;
    const wrapper = document.createElement("div");
    wrapper.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Muscle</th>
            <th>Action articulaire (rappel)</th>
            <th>Exemple d'exercice (√† compl√©ter)</th>
            <th>N¬∞ sur le sch√©ma</th>
          </tr>
        </thead>
        <tbody>
          ${MUSCLES_INFO.map((m, idx) => `
            <tr>
              <td>${m.name}</td>
              <td>${m.action}</td>
              <td>
                <input type="text"
                       class="muscles-input"
                       data-mline="${idx}"
                       data-field="exercise"
                       value="${lines[idx].exercise || ""}">
              </td>
              <td style="max-width:80px;">
                <input type="text"
                       class="muscles-input"
                       data-mline="${idx}"
                       data-field="num"
                       value="${lines[idx].num || ""}">
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    musclesSheetContainerEl.innerHTML = "";
    musclesSheetContainerEl.appendChild(wrapper);

    musclesSheetContainerEl.querySelectorAll(".muscles-input").forEach(input => {
      input.addEventListener("input", onMusclesSheetChange);
      input.addEventListener("change", onMusclesSheetChange);
    });
  }

  function onMusclesSheetChange(e) {
    const student = getSelectedStudent();
    if (!student) return;
    const idx = parseInt(e.target.dataset.mline, 10);
    const field = e.target.dataset.field;
    if (isNaN(idx) || !field) return;
    student.carnet.musclesSheet.lines[idx][field] = e.target.value;
    saveData();
  }

function renderLessons(student) {
  lessonsContainerEl.innerHTML = "";

  student.carnet.lessons.forEach((lesson, index) => {
    const details = document.createElement("details");
    details.className = "lesson";
    if (index === 0) details.open = true;

    const summary = document.createElement("summary");
    summary.textContent =
      `Le√ßon ${lesson.number}${lesson.validated ? " ‚úÖ" : ""} ${lesson.date ? " ‚Äì " + lesson.date : ""}`;
    details.appendChild(summary);

    const body = document.createElement("div");
    body.className = "lesson-body";

    /* ------------------ LE√áONS 1 ET 2 : FORMAT CLASSIQUE ------------------ */
    if (index === 0 || index === 1) {
      body.innerHTML = `
        <div class="section-title">Le√ßon ${lesson.number} ‚Äì Mon programme de musculation</div>

        <div class="row" style="margin-top:6px;">
          <div class="col">
            <label>Date de la le√ßon</label>
            <input type="date"
                   data-lesson="${index}"
                   data-field="date"
                   value="${lesson.date || ""}">
          </div>
        </div>

        <div class="state-box">
          <label>Mon √©tat de forme avant la s√©ance</label>
          <input type="range"
                 min="1"
                 max="10"
                 value="${lesson.stateLevel || "5"}"
                 class="state-slider"
                 data-lesson="${index}"
                 data-field="stateLevel">
          <div class="state-value">Niveau : ${lesson.stateLevel || "5"}/10</div>
          <div id="stateDesc_${index}" class="state-desc">
            ${STATE_DESCRIPTIONS[lesson.stateLevel || 5]}
          </div>
        </div>

        <div style="margin-top:8px;">
          <label>Mobile de travail</label>
    <select
      class="important-field"
      data-lesson="${index}"
      data-field="mobile">
      <option value=""></option>
      <option value="PUISSANCE" ${lesson.mobile === "PUISSANCE" ? "selected" : ""}>Puissance</option>
      <option value="TONIFICATION" ${lesson.mobile === "TONIFICATION" ? "selected" : ""}>Tonification</option>
    </select>
    <div class="pill-info">
      Puissance = explosivit√© ‚Ä¢ Tonification = travail plus soutenu
    </div>
  </div>
  <div>

        <div style="margin-top:8px;">
          <label>√âchauffement / Warm up</label>
          <textarea
            data-lesson="${index}"
            data-field="warmup"
            placeholder="D√©cris ton √©chauffement : mobilit√©s, cardio l√©ger, mise en action‚Ä¶">${lesson.warmup || ""}</textarea>
        </div>

        <div class="lesson-grid" style="margin-top:6px;">
  <div>
    <label>Nombre de s√©ries</label>
    <select
      class="important-field"
      data-lesson="${index}"
      data-field="seriesCount">
      <option value=""></option>
      <option value="3" ${lesson.seriesCount === "3" ? "selected" : ""}>3 s√©ries</option>
      <option value="4" ${lesson.seriesCount === "4" ? "selected" : ""}>4 s√©ries</option>
    </select>
  </div>
  <div>
    <label>Intensit√© choisie</label>
    <select
      class="important-field"
      data-lesson="${index}"
      data-field="intensity">
      <option value=""></option>
      <option value="30/30" ${lesson.intensity === "30/30" ? "selected" : ""}>30'' / 30''</option>
      <option value="40/20" ${lesson.intensity === "40/20" ? "selected" : ""}>40'' / 20''</option>
      <option value="45/15" ${lesson.intensity === "45/15" ? "selected" : ""}>45'' / 15''</option>
    </select>
  </div>
  <div>
    <label>R√©cup√©ration entre les s√©ries</label>
    <input
      type="text"
      class="important-field"
      data-lesson="${index}"
      data-field="recovery"
      placeholder="Ex : 1' active, 2' passive‚Ä¶"
      value="${lesson.recovery || ""}">
  </div>
</div>

        <div class="lesson-timer">
          <button type="button"
                  class="btn btn-sm"
                  data-lesson="${index}"
                  data-timer="start">
            Commencer la s√©ance
          </button>
          <button type="button"
                  class="btn btn-sm btn-secondary"
                  data-lesson="${index}"
                  data-timer="stop">
            Terminer la s√©ance
          </button>
          <span class="muted timer-display" id="timer_${index}">
            ${formatSeconds(lesson.chronoSeconds || 0)}
          </span>
        </div>

        <p class="muted" style="margin-bottom:4px;">
          Pour chaque exercice : muscles sollicit√©s, nom de l'exercice et validation par l‚Äôobservateur
          (posture, amplitude, respiration).
        </p>

        <div style="margin-bottom:6px;">
          <span class="muted" style="font-weight:600;">√Ä remplir par l‚Äôobservateur :</span>
          <input
            type="text"
            data-lesson="${index}"
            data-field="observerName"
            placeholder="Pr√©nom de l‚Äôobservateur"
            value="${lesson.observerName || ""}"
            style="margin-top:4px;max-width:220px;width:100%;">
        </div>

        <div class="scroll-table">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Muscles sollicit√©s</th>
                <th>Nom de l'exercice</th>
                <th class="obs-header">Posture</th>
                <th class="obs-header">Amplitude</th>
                <th class="obs-header">Respiration</th>
                <th class="obs-header">Remarques de l'observateur</th>
              </tr>
            </thead>
            <tbody>
              ${lesson.exercises.map((exo, exIndex) => `
                <tr>
                  <td>${exIndex + 1}</td>
                  <td>
                    <input type="text"
                      data-lesson="${index}"
                      data-ex-row="${exIndex}"
                      data-ex-field="muscles"
                      value="${exo.muscles || ""}">
                  </td>
                  <td>
                    <input type="text"
                      data-lesson="${index}"
                      data-ex-row="${exIndex}"
                      data-ex-field="name"
                      value="${exo.name || ""}">
                  </td>

                  <!-- POSTURE -->
                  <td class="obs-cell">
                    <div style="display:flex;flex-direction:column;gap:2px;font-size:0.8rem;">
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="posture"
                          name="posture_${index}_${exIndex}"
                          value="OUI"
                          ${exo.posture === "OUI" ? "checked" : ""}>
                        <span>Oui</span>
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="posture"
                          name="posture_${index}_${exIndex}"
                          value="CORRIGER"
                          ${exo.posture === "CORRIGER" ? "checked" : ""}>
                        <span>√Ä corriger</span>
                      </label>
                    </div>
                  </td>

                  <!-- AMPLITUDE -->
                  <td class="obs-cell">
                    <div style="display:flex;flex-direction:column;gap:2px;font-size:0.8rem;">
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="amplitude"
                          name="amplitude_${index}_${exIndex}"
                          value="OUI"
                          ${exo.amplitude === "OUI" ? "checked" : ""}>
                        <span>Oui</span>
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="amplitude"
                          name="amplitude_${index}_${exIndex}"
                          value="CORRIGER"
                          ${exo.amplitude === "CORRIGER" ? "checked" : ""}>
                        <span>√Ä corriger</span>
                      </label>
                    </div>
                  </td>

                  <!-- RESPIRATION -->
                  <td class="obs-cell">
                    <div style="display:flex;flex-direction:column;gap:2px;font-size:0.8rem;">
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="breathing"
                          name="breathing_${index}_${exIndex}"
                          value="OUI"
                          ${exo.breathing === "OUI" ? "checked" : ""}>
                        <span>Oui</span>
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="breathing"
                          name="breathing_${index}_${exIndex}"
                          value="CORRIGER"
                          ${exo.breathing === "CORRIGER" ? "checked" : ""}>
                        <span>√Ä corriger</span>
                      </label>
                    </div>
                  </td>

                  <!-- REMARQUES -->
                  <td class="obs-cell">
                    <input type="text"
                      data-lesson="${index}"
                      data-ex-row="${exIndex}"
                      data-ex-field="remark"
                      placeholder="Ex : √† la 8e r√©p, le mouvement se d√©grade"
                      value="${exo.remark || ""}">
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>

        <div class="ressenti-block" style="margin-top:10px;">
          <label>√âchelle de ressenti ‚Äì je me situe pour chaque ligne :</label>
          <div class="scroll-table">
            <table class="scale-table">
              <thead>
              <tr>
                <th>Crit√®re</th>
                <th class="res1 center">Niveau 1</th>
                <th class="res2 center">Niveau 2</th>
                <th class="res3 center">Niveau 3</th>
                <th class="res4 center">Niveau 4</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td>Perception de l‚Äôeffort</td>
                ${[1,2,3,4].map(n => `
                  <td class="res${n} center">
                    <input type="radio"
                           name="effort_${index}"
                           data-lesson="${index}"
                           data-field="effortLevel"
                           value="${n}" ${lesson.effortLevel === String(n) ? "checked" : ""}>
                  </td>`).join("")}
              </tr>
              <tr>
                <td>Sensations musculaires</td>
                ${[1,2,3,4].map(n => `
                  <td class="res${n} center">
                    <input type="radio"
                           name="muscles_${index}"
                           data-lesson="${index}"
                           data-field="musclesLevel"
                           value="${n}" ${lesson.musclesLevel === String(n) ? "checked" : ""}>
                  </td>`).join("")}
              </tr>
              <tr>
                <td>Sensations respiratoires</td>
                ${[1,2,3,4].map(n => `
                  <td class="res${n} center">
                    <input type="radio"
                           name="breath_${index}"
                           data-lesson="${index}"
                           data-field="breathLevel"
                           value="${n}" ${lesson.breathLevel === String(n) ? "checked" : ""}>
                  </td>`).join("")}
              </tr>
              <tr>
                <td>Sensation de chaleur</td>
                ${[1,2,3,4].map(n => `
                  <td class="res${n} center">
                    <input type="radio"
                           name="heat_${index}"
                           data-lesson="${index}"
                           data-field="heatLevel"
                           value="${n}" ${lesson.heatLevel === String(n) ? "checked" : ""}>
                  </td>`).join("")}
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="lesson-validation-block" style="margin-top:10px;">
          <div>
            <label>Bilan de la le√ßon</label>
            <textarea
              class="important-field"
              data-lesson="${index}"
              data-field="bilan"
              placeholder="Ce qui a bien fonctionn√©, ce qui est √† modifier, id√©es pour la prochaine s√©ance‚Ä¶">${lesson.bilan || ""}</textarea>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
            <input
              type="checkbox"
              id="validate_${index}"
              data-lesson="${index}"
              data-field="validated"
              ${lesson.validated ? "checked" : ""}
              style="transform:scale(1.1);">
            <label for="validate_${index}">
              Je valide / j‚Äôenregistre ma le√ßon ‚úÖ
            </label>
          </div>
        </div>
      `;
    }

    /* ------------------ LE√áON 3 : FORMAT SP√âCIAL 5 √âTAPES ------------------ */
    else if (index === 2) {
      body.innerHTML = `
      <div class="section-title">Le√ßon 3 ‚Äì S√©ance en 5 √©tapes</div>

      <!-- √âtape 1 : Testing FMS Deep Squat -->
      <div class="step-card">
        <div class="step-header">
          <span class="step-chip">√âtape 1</span>
          <h3>Testing ‚Äì FMS : Deep squat</h3>
        </div>

        <p class="muted">
          Test pour √©valuer ta <strong>mobilit√©</strong> et ta <strong>stabilit√©</strong>
          au niveau des hanches, chevilles et √©paules. Place-toi pieds largeur d‚Äô√©paules,
          b√¢ton au-dessus de la t√™te, puis r√©alise un squat le plus bas possible.
        </p>

        <div class="scroll-table" style="margin-top:6px;">
          <table class="scale-table">
            <thead>
              <tr>
                <th>Crit√®res √† respecter</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Genoux align√©s avec les pieds</td></tr>
              <tr><td>Les talons ne se d√©collent pas</td></tr>
              <tr><td>Bas du dos en position neutre</td></tr>
              <tr><td>Projection du b√¢ton dans l‚Äôaxe du corps</td></tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:8px;">
          <label>Niveau obtenu au test Deep squat</label>
          <div class="fms-level-grid">
            <label class="fms-level fms1">
              <input type="radio"
                     name="fmsDeepSquat_${index}"
                     value="1"
                     data-lesson="${index}"
                     data-field="fmsDeepSquatLevel"
                     ${lesson.fmsDeepSquatLevel === "1" ? "checked" : ""}>
              <span>
                Niveau 1<br>
                <small>Crit√®res non respect√©s</small>
              </span>
            </label>

            <label class="fms-level fms2">
              <input type="radio"
                     name="fmsDeepSquat_${index}"
                     value="2"
                     data-lesson="${index}"
                     data-field="fmsDeepSquatLevel"
                     ${lesson.fmsDeepSquatLevel === "2" ? "checked" : ""}>
              <span>
                Niveau 2<br>
                <small>Crit√®res respect√©s avec compensations</small>
              </span>
            </label>

            <label class="fms-level fms3">
              <input type="radio"
                     name="fmsDeepSquat_${index}"
                     value="3"
                     data-lesson="${index}"
                     data-field="fmsDeepSquatLevel"
                     ${lesson.fmsDeepSquatLevel === "3" ? "checked" : ""}>
              <span>
                Niveau 3<br>
                <small>Tous les crit√®res respect√©s</small>
              </span>
            </label>
          </div>
        </div>

        <div style="margin-top:6px;">
          <label>Remarques / axes de progr√®s</label>
          <textarea
            data-lesson="${index}"
            data-field="fmsDeepSquatNotes"
            placeholder="Ex : manque de mobilit√© de cheville, penser √† garder les talons au sol‚Ä¶"
          >${lesson.fmsDeepSquatNotes || ""}</textarea>
        </div>
      </div>

      <!-- √âtape 2 : Warm up -->
      <div class="step-card">
        <div class="step-header">
          <span class="step-chip">√âtape 2</span>
          <h3>Warm up</h3>
        </div>
        <p class="muted">√âchauffement complet : Mobilit√©s, Stabilit√©s, Activations globales.</p>
        <textarea
          data-lesson="${index}"
          data-field="step2Warmup"
          placeholder="D√©cris ton √©chauffement : exercices, dur√©e, consignes.">${lesson.step2Warmup || lesson.warmup || ""}</textarea>
      </div>

      <!-- √âtape 3 : Cha√Æne de progression du back squat -->
      <div class="step-card">
        <div class="step-header">
          <span class="step-chip">√âtape 3</span>
          <h3>Les cha√Ænes de progression ‚Äì Back squat</h3>
        </div>

        <p class="muted">
          Choisis le niveau que tu valides dans la cha√Æne de progression du back squat.
          Plus le num√©ro est grand, plus l‚Äôexercice est exigeant techniquement et
          musculairement.
        </p>

        <div class="squat-progression">
          <div class="squat-arrow-caption muted">
            Du <strong>plus facile</strong> ‚ûú vers <strong>plus difficile</strong>
          </div>

          <div class="squat-steps">
            <button type="button"
                    class="squat-step ${lesson.squatProgressionLevel === "1" ? "active" : ""}"
                    data-lesson="${index}"
                    data-squat-level="1">
              <span class="squat-number">1</span>
              <span class="squat-label">Air squat</span>
            </button>

            <button type="button"
                    class="squat-step ${lesson.squatProgressionLevel === "2" ? "active" : ""}"
                    data-lesson="${index}"
                    data-squat-level="2">
              <span class="squat-number">2</span>
              <span class="squat-label">Goblet squat</span>
            </button>

            <button type="button"
                    class="squat-step ${lesson.squatProgressionLevel === "3" ? "active" : ""}"
                    data-lesson="${index}"
                    data-squat-level="3">
              <span class="squat-number">3</span>
              <span class="squat-label">Unilat√©ral squat</span>
            </button>

            <button type="button"
                    class="squat-step ${lesson.squatProgressionLevel === "4" ? "active" : ""}"
                    data-lesson="${index}"
                    data-squat-level="4">
              <span class="squat-number">4</span>
              <span class="squat-label">Rack</span>
            </button>

            <button type="button"
                    class="squat-step ${lesson.squatProgressionLevel === "5" ? "active" : ""}"
                    data-lesson="${index}"
                    data-squat-level="5">
              <span class="squat-number">5</span>
              <span class="squat-label">Back squat</span>
            </button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <label>Remarques / explication de ton niveau</label>
          <textarea
            data-lesson="${index}"
            data-field="squatProgressionNotes"
            placeholder="Ex : je m‚Äôarr√™te au niveau 2, je dois encore gagner en stabilit√© du tronc et en mobilit√© de chevilles.">${lesson.squatProgressionNotes || ""}</textarea>
        </div>
      </div>

      
                <!-- √âtape 4 : Mont√©e en charge & observation du squat -->
          <div class="step-card">
            <div class="step-header">
              <span class="step-chip">√âtape 4</span>
              <h3>Mont√©e en charge & observation du squat</h3>
            </div>

            <p class="muted">
              R√©alise ton squat (niveau valid√© dans la cha√Æne de progression) sur <strong>10 r√©p√©titions</strong>.
              L‚Äôobservateur coche un drapeau <strong>vert ‚úÖ</strong> ou <strong>rouge ‚ùå</strong> pour chaque crit√®re.
            </p>

            <!-- Bouton pour afficher / cacher le sch√©ma -->
            <button type="button"
                    class="btn btn-sm btn-secondary"
                    data-lesson="${index}"
                    data-obs="toggleSchema">
              Commencer l‚Äôobservation
            </button>

            <!-- Sch√©ma + crit√®res (initialement masqu√©s) -->
            <div id="obsSchema_${index}" class="obs-schema" style="display:none;">
              <!-- Ton image sch√©ma ici -->
              <img src="schema-observation-squat.png"
                   alt="Sch√©ma d‚Äôobservation du squat (dos, √©quilibre, talons, amplitude, genoux)">

              <div class="obs-criteria-grid">
                <!-- DOS -->
                <div class="obs-criterion">
                  <div class="obs-criterion-label">Dos : fix√© / arrondi</div>
                  <div class="flag-options">
                    <label class="flag-option flag-green">
                      <input type="radio"
                             name="obs_dos_${index}"
                             value="OK"
                             data-lesson="${index}"
                             data-field="obsDos">
                      <span>‚úÖ</span>
                    </label>
                    <label class="flag-option flag-red">
                      <input type="radio"
                             name="obs_dos_${index}"
                             value="KO"
                             data-lesson="${index}"
                             data-field="obsDos">
                      <span>‚ùå</span>
                    </label>
                  </div>
                </div>

                <!-- EQUILIBRE -->
                <div class="obs-criterion">
                  <div class="obs-criterion-label">√âquilibre : stable / instable</div>
                  <div class="flag-options">
                    <label class="flag-option flag-green">
                      <input type="radio"
                             name="obs_equilibre_${index}"
                             value="OK"
                             data-lesson="${index}"
                             data-field="obsEquilibre">
                      <span>‚úÖ</span>
                    </label>
                    <label class="flag-option flag-red">
                      <input type="radio"
                             name="obs_equilibre_${index}"
                             value="KO"
                             data-lesson="${index}"
                             data-field="obsEquilibre">
                      <span>‚ùå</span>
                    </label>
                  </div>
                </div>

                <!-- TALONS -->
                <div class="obs-criterion">
                  <div class="obs-criterion-label">Talons : ancr√©s / se d√©collent</div>
                  <div class="flag-options">
                    <label class="flag-option flag-green">
                      <input type="radio"
                             name="obs_talons_${index}"
                             value="OK"
                             data-lesson="${index}"
                             data-field="obsTalons">
                      <span>‚úÖ</span>
                    </label>
                    <label class="flag-option flag-red">
                      <input type="radio"
                             name="obs_talons_${index}"
                             value="KO"
                             data-lesson="${index}"
                             data-field="obsTalons">
                      <span>‚ùå</span>
                    </label>
                  </div>
                </div>

                <!-- AMPLITUDE -->
                <div class="obs-criterion">
                  <div class="obs-criterion-label">Amplitude : compl√®te / partielle</div>
                  <div class="flag-options">
                    <label class="flag-option flag-green">
                      <input type="radio"
                             name="obs_amplitude_${index}"
                             value="OK"
                             data-lesson="${index}"
                             data-field="obsAmplitude">
                      <span>‚úÖ</span>
                    </label>
                    <label class="flag-option flag-red">
                      <input type="radio"
                             name="obs_amplitude_${index}"
                             value="KO"
                             data-lesson="${index}"
                             data-field="obsAmplitude">
                      <span>‚ùå</span>
                    </label>
                  </div>
                </div>

                <!-- GENOUX -->
                <div class="obs-criterion">
                  <div class="obs-criterion-label">Genoux : restent align√©s / rentrent</div>
                  <div class="flag-options">
                    <label class="flag-option flag-green">
                      <input type="radio"
                             name="obs_genoux_${index}"
                             value="OK"
                             data-lesson="${index}"
                             data-field="obsGenoux">
                      <span>‚úÖ</span>
                    </label>
                    <label class="flag-option flag-red">
                      <input type="radio"
                             name="obs_genoux_${index}"
                             value="KO"
                             data-lesson="${index}"
                             data-field="obsGenoux">
                      <span>‚ùå</span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- R√©sum√© + exos √† travailler -->
              <div id="obsSummary_${index}" class="muted" style="margin-top:8px;">
                Compl√®te les drapeaux pour afficher le bilan.
              </div>
              <div id="obsAxisExos_${index}" style="margin-top:4px;"></div>

              <!-- Bouton pour calculer les axes + exos -->
              <button type="button"
                      class="btn btn-sm"
                      data-lesson="${index}"
                      data-obs="showResult"
                      style="margin-top:6px;">
                Voir les axes √† travailler et les exercices
              </button>
            </div>

            <!-- RER -->
            <div style="margin-top:8px;">
              <label>Ton RER (r√©p√©titions en r√©serve) sur ce squat</label>
              <input type="number"
                     min="0"
                     max="10"
                     data-lesson="${index}"
                     data-field="rerSquat"
                     placeholder="Ex : 2 (il restait 2 r√©p√©titions possibles)"
                     value="${lesson.rerSquat || ""}">
              <p class="muted" style="margin-top:2px;">
                RER = nombre de r√©p√©titions que tu aurais encore pu faire √† la fin de ta s√©rie.
              </p>
            </div>
          </div>


      <!-- √âtape 5 : Le finish -->
<div class="step-card">
  <div class="step-header">
    <span class="step-chip">√âtape 5</span>
    <h3>Le finish</h3>
  </div>

  <p class="muted">
    Derni√®re partie de la s√©ance : cardio final, challenge ou retour au calme.
  </p>

  <!-- CADRE : Membres du groupe -->
  <div style="
    margin-top:10px;
    padding:10px;
    border-radius:10px;
    background:#f3f4f6;
    border:1px solid #d1d5db;">
    <label style="font-weight:600;">Membres du groupe (3 √©l√®ves)</label>
    <textarea
      data-lesson="${index}"
      data-field="groupMembers"
      placeholder="Ex : L√©o, Amine, Sarah"
      style="margin-top:6px; width:100%; min-height:50px;">${lesson.groupMembers || ""}</textarea>
  </div>

  <!-- COMPTEUR DE TOURS -->
  <div style="
    margin-top:12px;
    padding:10px;
    border-radius:10px;
    background:#e8f0ff;
    border:1px solid #bcd0ff;
    text-align:center;">
    
    <label style="font-weight:600;">Nombre de tours r√©alis√©s par le groupe</label>

    <div style="margin-top:8px; font-size:1.4rem; font-weight:700;">
      <span id="roundCounter_${index}">
        ${lesson.finishRounds || 0}
      </span>
      &nbsp;üèÅ
    </div>

    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
      <button
        type="button"
        class="btn btn-sm"
        data-round-action="plus"
        data-lesson="${index}">
        +1 tour
      </button>

      <button
        type="button"
        class="btn btn-sm btn-secondary"
        data-round-action="minus"
        data-lesson="${index}">
        -1 tour
      </button>
    </div>
  </div>

  <!-- Zone bilan du finish -->
  <textarea
    data-lesson="${index}"
    data-field="step5Finish"
    placeholder="Ex : circuit cardio, challenge de r√©p√©titions, retour au calme, √©tirements."
    style="margin-top:12px;">${lesson.step5Finish || ""}</textarea>
</div>

      <!-- Programme + observateur + ressenti + bilan (comme d‚Äôhabitude) -->
      <div style="margin-top:12px;">
        <div class="section-title">Programme de la le√ßon</div>

        <div class="lesson-timer">
          <button type="button"
                  class="btn btn-sm"
                  data-lesson="${index}"
                  data-timer="start">
            Commencer la s√©ance
          </button>
          <button type="button"
                  class="btn btn-sm btn-secondary"
                  data-lesson="${index}"
                  data-timer="stop">
            Terminer la s√©ance
          </button>
          <span class="muted timer-display" id="timer_${index}">
            ${formatSeconds(lesson.chronoSeconds || 0)}
          </span>
        </div>

        <p class="muted" style="margin-bottom:4px;">
          Pour chaque exercice : muscles sollicit√©s, nom de l'exercice et validation par l‚Äôobservateur
          (posture, amplitude, respiration).
        </p>

        <div style="margin-bottom:6px;">
          <span class="muted" style="font-weight:600;">√Ä remplir par l‚Äôobservateur :</span>
          <input
            type="text"
            data-lesson="${index}"
            data-field="observerName"
            placeholder="Pr√©nom de l‚Äôobservateur"
            value="${lesson.observerName || ""}"
            style="margin-top:4px;max-width:220px;width:100%;">
        </div>

        <div class="scroll-table">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Muscles sollicit√©s</th>
                <th>Nom de l'exercice</th>
                <th class="obs-header">Posture</th>
                <th class="obs-header">Amplitude</th>
                <th class="obs-header">Respiration</th>
                <th class="obs-header">Remarques de l'observateur</th>
              </tr>
            </thead>
            <tbody>
              ${lesson.exercises.map((exo, exIndex) => `
                <tr>
                  <td>${exIndex + 1}</td>
                  <td>
                    <input type="text"
                      data-lesson="${index}"
                      data-ex-row="${exIndex}"
                      data-ex-field="muscles"
                      value="${exo.muscles || ""}">
                  </td>
                  <td>
                    <input type="text"
                      data-lesson="${index}"
                      data-ex-row="${exIndex}"
                      data-ex-field="name"
                      value="${exo.name || ""}">
                  </td>

                  <td class="obs-cell">
                    <div style="display:flex;flex-direction:column;gap:2px;font-size:0.8rem;">
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="posture"
                          name="posture_${index}_${exIndex}"
                          value="OUI"
                          ${exo.posture === "OUI" ? "checked" : ""}>
                        <span>Oui</span>
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="posture"
                          name="posture_${index}_${exIndex}"
                          value="CORRIGER"
                          ${exo.posture === "CORRIGER" ? "checked" : ""}>
                        <span>√Ä corriger</span>
                      </label>
                    </div>
                  </td>

                  <td class="obs-cell">
                    <div style="display:flex;flex-direction:column;gap:2px;font-size:0.8rem;">
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="amplitude"
                          name="amplitude_${index}_${exIndex}"
                          value="OUI"
                          ${exo.amplitude === "OUI" ? "checked" : ""}>
                        <span>Oui</span>
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="amplitude"
                          name="amplitude_${index}_${exIndex}"
                          value="CORRIGER"
                          ${exo.amplitude === "CORRIGER" ? "checked" : ""}>
                        <span>√Ä corriger</span>
                      </label>
                    </div>
                  </td>

                  <td class="obs-cell">
                    <div style="display:flex;flex-direction:column;gap:2px;font-size:0.8rem;">
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="breathing"
                          name="breathing_${index}_${exIndex}"
                          value="OUI"
                          ${exo.breathing === "OUI" ? "checked" : ""}>
                        <span>Oui</span>
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;">
                        <input
                          type="radio"
                          data-lesson="${index}"
                          data-ex-row="${exIndex}"
                          data-ex-field="breathing"
                          name="breathing_${index}_${exIndex}"
                          value="CORRIGER"
                          ${exo.breathing === "CORRIGER" ? "checked" : ""}>
                        <span>√Ä corriger</span>
                      </label>
                    </div>
                  </td>

                  <td class="obs-cell">
                    <input type="text"
                      data-lesson="${index}"
                      data-ex-row="${exIndex}"
                      data-ex-field="remark"
                      placeholder="Ex : √† la 8e r√©p, le mouvement se d√©grade"
                      value="${exo.remark || ""}">
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>

      <div class="ressenti-block" style="margin-top:10px;">
        <label>√âchelle de ressenti ‚Äì je me situe pour chaque ligne :</label>
        <div class="scroll-table">
          <table class="scale-table">
            <thead>
            <tr>
              <th>Crit√®re</th>
              <th class="res1 center">Niveau 1</th>
              <th class="res2 center">Niveau 2</th>
              <th class="res3 center">Niveau 3</th>
              <th class="res4 center">Niveau 4</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>Perception de l‚Äôeffort</td>
              ${[1,2,3,4].map(n => `
                <td class="res${n} center">
                  <input type="radio"
                         name="effort_${index}"
                         data-lesson="${index}"
                         data-field="effortLevel"
                         value="${n}" ${lesson.effortLevel === String(n) ? "checked" : ""}>
                </td>`).join("")}
            </tr>
            <tr>
              <td>Sensations musculaires</td>
              ${[1,2,3,4].map(n => `
                <td class="res${n} center">
                  <input type="radio"
                         name="muscles_${index}"
                         data-lesson="${index}"
                         data-field="musclesLevel"
                         value="${n}" ${lesson.musclesLevel === String(n) ? "checked" : ""}>
                </td>`).join("")}
            </tr>
            <tr>
              <td>Sensations respiratoires</td>
              ${[1,2,3,4].map(n => `
                <td class="res${n} center">
                  <input type="radio"
                         name="breath_${index}"
                         data-lesson="${index}"
                         data-field="breathLevel"
                         value="${n}" ${lesson.breathLevel === String(n) ? "checked" : ""}>
                </td>`).join("")}
            </tr>
            <tr>
              <td>Sensation de chaleur</td>
              ${[1,2,3,4].map(n => `
                <td class="res${n} center">
                  <input type="radio"
                         name="heat_${index}"
                         data-lesson="${index}"
                         data-field="heatLevel"
                         value="${n}" ${lesson.heatLevel === String(n) ? "checked" : ""}>
                </td>`).join("")}
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="lesson-validation-block" style="margin-top:10px;">
        <div>
          <label>Bilan de la le√ßon</label>
          <textarea
            class="important-field"
            data-lesson="${index}"
            data-field="bilan"
            placeholder="Ce qui a bien fonctionn√©, ce qui est √† modifier, id√©es pour la prochaine s√©ance‚Ä¶">${lesson.bilan || ""}</textarea>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
          <input
            type="checkbox"
            id="validate_${index}"
            data-lesson="${index}"
            data-field="validated"
            ${lesson.validated ? "checked" : ""}
            style="transform:scale(1.1);">
          <label for="validate_${index}">
            Je valide / j‚Äôenregistre ma le√ßon ‚úÖ
          </label>
        </div>
      </div>
      `;
    }

    

    /* ------------------ LE√áONS 4 √Ä 8 : RIEN POUR LE MOMENT ------------------ */
    else {
      body.innerHTML = `
        <p class="muted">Le√ßon ${lesson.number} : contenu √† venir.</p>
      `;
    }

    details.appendChild(body);
    lessonsContainerEl.appendChild(details);
  });

  // Listeners g√©n√©raux (communs √† toutes les le√ßons)
  lessonsContainerEl
    .querySelectorAll("input[data-field], textarea[data-field], select[data-field]")
    .forEach(el => {
      el.addEventListener("change", onLessonFieldChange);
      el.addEventListener("input", onLessonFieldChange);
    });

  lessonsContainerEl
    .querySelectorAll("input[data-ex-row], select[data-ex-row]")
    .forEach(el => {
      el.addEventListener("change", onLessonExerciseChange);
      el.addEventListener("input", onLessonExerciseChange);
    });

  // Clic sur les niveaux de la cha√Æne de progression (back squat ‚Äì le√ßon 3)
    // Clic sur les niveaux de la cha√Æne de progression (back squat ‚Äì le√ßon 3)
  lessonsContainerEl.querySelectorAll(".squat-step").forEach(btn => {
    btn.addEventListener("click", () => {
      const lessonIndex = parseInt(btn.dataset.lesson, 10);
      const level = btn.dataset.squatLevel;
      const student = getSelectedStudent();
      if (!student || !student.carnet || !student.carnet.lessons[lessonIndex]) return;

      const lesson = student.carnet.lessons[lessonIndex];
      // on enregistre le niveau choisi
      lesson.squatProgressionLevel = level;
      saveData();

      // Mise √† jour visuelle : un seul niveau actif pour cette le√ßon
      lessonsContainerEl
        .querySelectorAll(`.squat-step[data-lesson="${lessonIndex}"]`)
        .forEach(b => {
          b.classList.toggle("active", b.dataset.squatLevel === level);
        });
    });
  });

  // COMPTEUR DE TOURS ‚Äì √âtape 5
  lessonsContainerEl.querySelectorAll("[data-round-action]").forEach(btn => {
    btn.addEventListener("click", () => {
      const student = getSelectedStudent();
      if (!student || !student.carnet) return;

      const lessonIndex = parseInt(btn.dataset.lesson, 10);
      const lesson = student.carnet.lessons[lessonIndex];
      if (!lesson) return;

      // valeur par d√©faut
      if (typeof lesson.finishRounds !== "number") {
        lesson.finishRounds = Number(lesson.finishRounds) || 0;
      }

      const action = btn.dataset.roundAction;
      if (action === "plus") lesson.finishRounds++;
      if (action === "minus" && lesson.finishRounds > 0) lesson.finishRounds--;

      // Mise √† jour visuelle du compteur
      const counterEl = document.getElementById(`roundCounter_${lessonIndex}`);
      if (counterEl) counterEl.textContent = lesson.finishRounds;

      saveData();
    });
  });

  // Boutons de chrono
  lessonsContainerEl.querySelectorAll("[data-timer='start']").forEach(btn => {
    btn.addEventListener("click", onTimerStart);
  });
  lessonsContainerEl.querySelectorAll("[data-timer='stop']").forEach(btn => {
    btn.addEventListener("click", onTimerStop);
  });

  // Mise √† jour visuelle initiale des timers
  student.carnet.lessons.forEach((_, idx) => updateTimerDisplayFor(idx));
}
  // Bouton "Commencer l'observation" (affiche / cache la grille √âtape 4)
  lessonsContainerEl.querySelectorAll("[data-obs='toggleSchema']").forEach(btn => {
    btn.addEventListener("click", () => {
      const lessonIndex = parseInt(btn.dataset.lesson, 10);
      const schema = document.getElementById(`obsSchema_${lessonIndex}`);
      if (!schema) return;

      const isHidden = (schema.style.display === "" || schema.style.display === "none");
      schema.style.display = isHidden ? "block" : "none";
    });
  });

  // Bouton "Voir les axes √† travailler et les exercices"
  lessonsContainerEl.querySelectorAll("[data-obs='showResult']").forEach(btn => {
    btn.addEventListener("click", () => {
      const lessonIndex = parseInt(btn.dataset.lesson, 10);
      updateStep4Summary(lessonIndex);
    });
  });

  // Bouton "Commencer l'observation" (affiche / cache la grille)
  lessonsContainerEl.querySelectorAll(".step4-toggle").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = btn.dataset.lesson;
      const content = document.getElementById(`step4Content_${idx}`);
      if (!content) return;
      const visible = content.style.display !== "none";
      content.style.display = visible ? "none" : "block";

      // Met √† jour le r√©sum√© quand on ouvre pour la le√ßon 3
      const lessonIndex = parseInt(idx, 10);
      if (!visible && lessonIndex === 2) {
        updateStep4Summary(lessonIndex);
      }
    });
  });

  // Clic sur les drapeaux verts / rouges
  lessonsContainerEl.querySelectorAll("[data-step4-crit]").forEach(btn => {
    btn.addEventListener("click", () => {
      const lessonIndex = parseInt(btn.dataset.lesson, 10);
      const crit = btn.dataset.step4Crit;   // "dos", "equilibre", ...
      const flag = btn.dataset.flag;        // "GREEN" ou "RED"

      const student = getSelectedStudent();
      if (!student || !student.carnet || !student.carnet.lessons[lessonIndex]) return;
      const lesson = student.carnet.lessons[lessonIndex];

      const prop = "step4" + crit.charAt(0).toUpperCase() + crit.slice(1);
      lesson[prop] = flag;
      saveData();

      // Visuel : un seul drapeau actif par crit√®re
      lessonsContainerEl
        .querySelectorAll(`[data-lesson="${lessonIndex}"][data-step4-crit="${crit}"]`)
        .forEach(b => {
          b.classList.toggle("active", b.dataset.flag === flag);
        });

      if (lessonIndex === 2) {
        updateStep4Summary(lessonIndex);
      }
    });
  });

  // Mise √† jour initiale du r√©sum√© pour la le√ßon 3
  updateStep4Summary(2);

 function onLessonFieldChange(e) {
  const student = getSelectedStudent();
  if (!student) return;

  const lessonIndex = parseInt(e.target.dataset.lesson, 10);
  if (isNaN(lessonIndex) || !student.carnet || !student.carnet.lessons[lessonIndex]) return;

  const lesson = student.carnet.lessons[lessonIndex];
  const field = e.target.dataset.field;
  if (!field) return;

  let value;
  if (e.target.type === "checkbox") {
    value = e.target.checked;
  } else {
    value = e.target.value;
  }
  lesson[field] = value;
  saveData();

  // Mise √† jour du titre avec la date et/ou la validation
  if (field === "date" || field === "validated") {
    const details = e.target.closest("details.lesson");
    const summary = details.querySelector("summary");
    summary.textContent =
      `Le√ßon ${lesson.number}${lesson.validated ? " ‚úÖ" : ""} ${lesson.date ? " ‚Äì " + lesson.date : ""}`;
  }

  // Mise √† jour du texte pour l'√©tat de forme
  if (field === "stateLevel") {
    const level = e.target.value || "5";

    const descEl = document.getElementById(`stateDesc_${lessonIndex}`);
    if (descEl && STATE_DESCRIPTIONS[level]) {
      descEl.textContent =
        `√âtat de forme niveau ${level} : ${STATE_DESCRIPTIONS[level]}`;
    }

    const valueEl = e.target.parentElement.querySelector(".state-value");
    if (valueEl) {
      valueEl.textContent = `Niveau : ${level}/10`;
    }
  }
    if (field === "step4Rer" && lessonIndex === 2) {
    updateStep4Summary(lessonIndex);
  }
}

  function onLessonExerciseChange(e) {
    const student = getSelectedStudent();
    if (!student) return;
    const lessonIndex = parseInt(e.target.dataset.lesson, 10);
    const rowIndex = parseInt(e.target.dataset.exRow, 10);
    const field = e.target.dataset.exField;
    if (isNaN(lessonIndex) || isNaN(rowIndex) || !field) return;
    const lesson = student.carnet.lessons[lessonIndex];
    if (!lesson || !lesson.exercises[rowIndex]) return;
    lesson.exercises[rowIndex][field] = e.target.value;
    saveData();
  }
// --- √âtape 4 : calcul du r√©sultat d'observation + axes + exercices ---
function computeObservationAxes(lessonIndex) {
  const student = getSelectedStudent();
  if (!student || !student.carnet || !student.carnet.lessons[lessonIndex]) return;

  const lesson = student.carnet.lessons[lessonIndex];

  // R√©cup√©rer les choix OK / KO pour chaque crit√®re
  const getValue = (nameBase) => {
    const input = document.querySelector(`input[name="${nameBase}_${lessonIndex}"]:checked`);
    return input ? input.value : null;
  };

  const criteria = [
    { key: "dos",       name: "obs_dos",       axis: "C", label: "Dos" },
    { key: "equilibre", name: "obs_equilibre", axis: "B", label: "√âquilibre" },
    { key: "talons",    name: "obs_talons",    axis: "C", label: "Talons" },
    { key: "genoux",    name: "obs_genoux",    axis: "A", label: "Genoux" },
    { key: "amplitude", name: "obs_amplitude", axis: "C", label: "Amplitude" }
  ];

  let verts = 0;
  let rouges = 0;
  const axesSet = new Set();

  criteria.forEach(c => {
    const val = getValue(c.name);
    if (!val) return;
    lesson[`obs${c.key.charAt(0).toUpperCase()}${c.key.slice(1)}`] = val;

    if (val === "OK") {
      verts++;
    } else if (val === "KO") {
      rouges++;
      axesSet.add(c.axis);
    }
  });

  lesson.obsResult = {
    verts,
    rouges,
    axes: Array.from(axesSet)
  };
  saveData();

  const summaryEl = document.getElementById(`obsSummary_${lessonIndex}`);
  const axisExosEl = document.getElementById(`obsAxisExos_${lessonIndex}`);
  if (!summaryEl || !axisExosEl) return;

  if (!verts && !rouges) {
    summaryEl.textContent = "Compl√®te d'abord l'observation (drapeaux verts / rouges).";
    axisExosEl.innerHTML = "";
    return;
  }

  // Texte r√©capitulatif
  summaryEl.innerHTML = `
    <strong>Bilan :</strong> ${verts} drapeau(x) vert(s) ‚Äì ${rouges} drapeau(x) rouge(s).<br>
    Axes prioritaires √† travailler : ${
      lesson.obsResult.axes.length
        ? lesson.obsResult.axes.map(a => `(${a}) ${AXIS_EXERCISES[a].label.split(") ")[1]}`).join(", ")
        : "aucun axe particulier ‚Äì poursuis au niveau actuel."
    }
  `;

  // Affichage des exercices conseill√©s
  if (!lesson.obsResult.axes.length) {
    axisExosEl.innerHTML = "";
    return;
  }

  axisExosEl.innerHTML = lesson.obsResult.axes.map(axis => {
    const info = AXIS_EXERCISES[axis];
    if (!info) return "";
    return `
      <div class="step-card" style="margin-top:6px;">
        <div class="step-header">
          <span class="step-chip">${info.label}</span>
        </div>
        <p class="muted" style="margin-bottom:4px;">${info.description}</p>
        <ul class="muted" style="padding-left:18px;margin:0;">
          ${info.exercises.map(ex => `<li>${ex}</li>`).join("")}
        </ul>
      </div>
    `;
  }).join("");
}

document.addEventListener("click", (e) => {
  if (e.target.matches("[data-obs='toggleSchema']")) {
    const lessonIndex = parseInt(e.target.dataset.lesson, 10);
    if (isNaN(lessonIndex)) return;
    const box = document.getElementById(`obsSchema_${lessonIndex}`);
    if (!box) return;

    // On alterne visible / cach√©
    box.style.display = (box.style.display === "none" || box.style.display === "")
      ? "block"
      : "none";
  }
});

  /* ----- Auto-√©valuation ----- */

  function syncSelfEvalUI(student) {
    const selfEval = student.carnet.selfEval || {};
    document.querySelectorAll("[data-self-afl]").forEach(input => {
      const key = input.dataset.selfAfl;
      if (selfEval[key] && selfEval[key] === input.value) {
        input.checked = true;
      } else {
        input.checked = false;
      }
      input.addEventListener("change", onSelfEvalChange);
    });
    selfEvalNoteEl.value = selfEval.note || "";
    updateSelfEvalSummary(selfEval.note || "");
    selfEvalNoteEl.addEventListener("input", onSelfEvalNoteChange);
  }

  function onSelfEvalChange(e) {
    const student = getSelectedStudent();
    if (!student) return;
    const key = e.target.dataset.selfAfl;
    if (!key) return;
    if (!student.carnet.selfEval) {
      student.carnet.selfEval = { afl1e1: "", afl1e2: "", afl2: "", afl3: "", note: "" };
    }
    student.carnet.selfEval[key] = e.target.value;
    saveData();
  }

  function onSelfEvalNoteChange(e) {
    const student = getSelectedStudent();
    if (!student) return;
    if (!student.carnet.selfEval) {
      student.carnet.selfEval = { afl1e1: "", afl1e2: "", afl2: "", afl3: "", note: "" };
    }
    student.carnet.selfEval.note = e.target.value;
    saveData();
    updateSelfEvalSummary(e.target.value);
  }

  function updateSelfEvalSummary(note) {
    selfEvalSummaryEl.textContent = note
      ? `Ma note : ${note}`
      : "Ma note : ‚Ä¶";
  }

  /* ----- Onglets ----- */

  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = {
    muscles: document.getElementById("tab-muscles"),
    lessons: document.getElementById("tab-lessons"),
    evaluation: document.getElementById("tab-evaluation"),
    infos: document.getElementById("tab-infos"),
    exercises: document.getElementById("tab-exercises")
  };

  function setActiveTab(name) {
    tabButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === name);
    });
    Object.keys(tabPanels).forEach(key => {
      tabPanels[key].classList.toggle("active", key === name);
    });
      if (name === "exercises") {
    renderExerciseList();
  }
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
  });

  /* ----- Listeners g√©n√©raux ----- */

  selectClassEl.addEventListener("change", () => {
    appState.selectedClassId = selectClassEl.value || null;
  });

  btnAddClass.addEventListener("click", addClass);
  btnDeleteClass.addEventListener("click", deleteClass);
  if (goToStudentsText) {
  goToStudentsText.addEventListener("click", goToStudentsView);
}


  btnAddStudent.addEventListener("click", addStudent);
  newStudentNameEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      addStudent();
    }
  });

  backToClassesEl.addEventListener("click", () => {
    showView("classes");
    saveData();
  });

  backToStudentsEl.addEventListener("click", () => {
    showView("students");
    renderStudents();
    saveData();
  });

  // Filtres exercices + modale
const catFilterEl = document.getElementById("exerciseCategoryFilter");
const searchExEl = document.getElementById("exerciseSearch");
if (catFilterEl && searchExEl) {
  catFilterEl.addEventListener("change", renderExerciseList);
  searchExEl.addEventListener("input", renderExerciseList);
}

const closeModalBtn = document.getElementById("closeExerciseModal");
if (closeModalBtn) {
  closeModalBtn.addEventListener("click", closeExerciseModal);
}

const exerciseModal = document.getElementById("exerciseModal");
if (exerciseModal) {
  exerciseModal.addEventListener("click", (e) => {
    if (e.target === exerciseModal) closeExerciseModal();
  });
}
/* ----- Init ----- */

// On essaye d‚Äôabord de r√©cup√©rer les donn√©es de Firebase,
// puis on affiche l‚Äôinterface.
(async function init() {
  await syncFromFirebase();
  renderClassSelect();
  showView("classes");
})();

</script>
</body>
</html>
